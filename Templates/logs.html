{% extends "base.html" %}
{% block title %}Logs & Activity - MT5 Trade Copier{% endblock %}
{% block page_title %}<i class="fas fa-terminal"></i> Logs & Activity{% endblock %}

{% block extra_css %}
<style>
        /* Page Header */
    .page-header { display: flex !important; align-items: center !important; margin-bottom: 32px !important; gap: 24px !important; }
    .page-desc { font-size: 12px !important; font-weight: 600 !important; color: var(--text-muted) !important; flex-shrink: 0 !important; }
    .header-actions { display: flex !important; gap: 12px !important; margin-left: auto !important; }
    .header-btn { padding: 10px 18px !important; background: var(--bg-card) !important; color: var(--text-secondary) !important; border: 1px solid var(--border) !important; border-radius: 999px !important; font-size: 13px !important; font-weight: 600 !important; cursor: pointer !important; display: flex !important; align-items: center !important; gap: 8px !important; transition: all 0.2s !important; }
    .header-btn:hover { border-color: var(--border-hover); color: var(--text-primary); background: var(--bg-hover); }
    .header-btn.refresh { background: var(--accent-dim); color: var(--text-secondary); }
    .header-btn.refresh:hover { background: var(--accent-dim); color: var(--text-primary); }

    /* Stats Row - Horizontal Grid */
    .log-stats { display: grid; grid-template-columns: repeat(5, 1fr); gap: 18px; margin-bottom: 28px; }
    .log-stat { display: flex; align-items: center; gap: 14px; padding: 20px 24px; background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 10px; transition: all 0.3s ease; }
    .log-stat:hover { border-color: var(--border-light); background: rgba(255,255,255,0.04); }
    .log-stat-icon { width: 46px; height: 46px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }
    .log-stat-icon.all { background: var(--accent-dim); color: var(--text-primary); }
    .log-stat-icon.trade { background: var(--success-dim); color: var(--success); }
    .log-stat-icon.copy { background: var(--info-dim); color: var(--info); }
    .log-stat-icon.error { background: var(--danger-dim); color: var(--danger); }
    .log-stat-icon.info { background: var(--warning-dim); color: var(--warning); }
    .log-stat-info { flex: 1; }
    .log-stat-value { font-size: 24px; font-weight: 700; font-family: 'JetBrains Mono', monospace; line-height: 1; }
    .log-stat-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1.5px; margin-top: 6px; }

    /* Filters Bar - Improved Spacing */
    .filters-bar { display: flex; align-items: center; gap: 18px; padding: 20px 24px; background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 10px; margin-bottom: 28px; flex-wrap: wrap; }
    .filter-group { display: flex; align-items: center; gap: 12px; flex-shrink: 0; }
    .filter-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-muted); white-space: nowrap; }
    .filter-select { padding: 12px 16px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 12px; cursor: pointer; min-width: 150px; transition: all 0.2s; }
    .filter-select:hover { border-color: var(--border-light); }
    .filter-select:focus { outline: none; border-color: var(--info); }
    .filter-select option { background: var(--bg-card); color: var(--text-primary); }
    .filter-input { padding: 12px 16px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 12px; min-width: 200px; flex: 1; min-width: 160px; transition: all 0.2s; }
    .filter-input:hover { border-color: var(--border-light); }
    .filter-input:focus { outline: none; border-color: var(--info); }
    .filter-input::placeholder { color: var(--text-muted); }
    .filter-btn { padding: 12px 18px; border-radius: 8px; font-size: 11px; font-weight: 600; border: none; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s; flex-shrink: 0; }
    .filter-btn.clear { background: transparent; color: var(--text-secondary); border: 1px solid var(--border); }
    .filter-btn.clear:hover { background: var(--danger-dim); color: var(--danger); border-color: var(--danger); }

    /* Log Container */
    .log-container { background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; }
    .log-header { padding: 20px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .log-title { font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 2px; color: var(--text-muted); display: flex; align-items: center; gap: 10px; }
    .log-title::before { content: ''; width: 4px; height: 16px; background: linear-gradient(180deg, var(--success), var(--info)); border-radius: 2px; }
    .log-header-right { display: flex; align-items: center; gap: 20px; }
    .log-count { font-size: 11px; padding: 8px 14px; background: var(--accent-dim); border: 1px solid var(--border); border-radius: 10px; }
    .log-actions { display: flex; gap: 8px; }
    .log-action-btn { width: 38px; height: 38px; border-radius: 8px; border: 1px solid var(--border); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; transition: all 0.2s; background: transparent; color: var(--text-muted); }
    .log-action-btn:hover { background: var(--accent-dim); border-color: var(--border-light); color: var(--text-primary); }
    .log-action-btn.active { background: var(--success-dim); border-color: var(--success); color: var(--success); }

    /* Log List */
    .log-list { max-height: 600px; overflow-y: auto; }
    .log-item { display: flex; align-items: flex-start; gap: 18px; padding: 18px 24px; border-bottom: 1px solid rgba(255,255,255,0.02); transition: all 0.15s; }
    .log-item:hover { background: rgba(255,255,255,0.04); }
    .log-item:last-child { border-bottom: none; }
    .log-type-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0; }
    .log-type-icon.trade { background: var(--success-dim); color: var(--success); }
    .log-type-icon.copy { background: var(--info-dim); color: var(--info); }
    .log-type-icon.error { background: var(--danger-dim); color: var(--danger); }
    .log-type-icon.warning { background: var(--warning-dim); color: var(--warning); }
    .log-type-icon.info { background: var(--purple); color: #fff; opacity: 0.8; }
    .log-type-icon.system { background: var(--accent-dim); color: var(--text-secondary); }
    .log-content { flex: 1; min-width: 0; }
    .log-message { font-size: 13px; line-height: 1.6; margin-bottom: 10px; word-break: break-word; }
    .log-message .highlight { color: var(--success); font-weight: 600; }
    .log-message .account { color: var(--info); font-family: 'JetBrains Mono', monospace; }
    .log-message .symbol { color: var(--warning); font-weight: 600; }
    .log-message .error-text { color: var(--danger); }
    .log-meta { display: flex; flex-wrap: wrap; gap: 16px; font-size: 11px; color: var(--text-muted); }
    .log-meta-item { display: flex; align-items: center; gap: 6px; }
    .log-meta-item i { font-size: 10px; opacity: 0.6; }
    .log-time { font-size: 11px; color: var(--text-muted); white-space: nowrap; font-family: 'JetBrains Mono', monospace; flex-shrink: 0; }

    /* Empty Log */
    .log-empty { padding: 100px 40px; text-align: center; }
    .log-empty i { font-size: 56px; opacity: 0.08; margin-bottom: 20px; }
    .log-empty h4 { font-size: 16px; font-weight: 600; margin-bottom: 8px; color: var(--text-secondary); }
    .log-empty p { font-size: 12px; color: var(--text-muted); }

    /* Scrollbar */
    .log-list::-webkit-scrollbar { width: 6px; }
    .log-list::-webkit-scrollbar-track { background: rgba(255,255,255,0.02); }
    .log-list::-webkit-scrollbar-thumb { background: var(--border-light); border-radius: 3px; }
    .log-list::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

    @media (max-width: 1200px) {
        .log-stats { grid-template-columns: repeat(3, 1fr); }
    }
    @media (max-width: 768px) {
        .log-stats { grid-template-columns: repeat(2, 1fr); }
        .filters-bar { flex-direction: column; align-items: stretch; }
        .filter-group { width: 100%; }
        .filter-select, .filter-input { width: 100%; }
    }
    html[data-theme="light"] .page-desc { font-size: 12px !important; font-weight: 600 !important; color: var(--text-muted) !important; flex-shrink: 0 !important; } html[data-theme="light"] .header-btn { padding: 10px 18px !important; background: var(--bg-card) !important; color: var(--text-secondary) !important; border: 1px solid var(--border) !important; border-radius: 999px !important; font-size: 13px !important; font-weight: 600 !important; cursor: pointer !important; display: flex !important; align-items: center !important; gap: 8px !important; transition: all 0.2s !important; }
    html[data-theme="light"] .page-desc { font-size: 12px !important; font-weight: 600 !important; color: var(--text-muted) !important; flex-shrink: 0 !important; } html[data-theme="light"] .header-btn { padding: 10px 18px !important; background: var(--bg-card) !important; color: var(--text-secondary) !important; border: 1px solid var(--border) !important; border-radius: 999px !important; font-size: 13px !important; font-weight: 600 !important; cursor: pointer !important; display: flex !important; align-items: center !important; gap: 8px !important; transition: all 0.2s !important; }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header" style="display: flex; justify-content: space-between; align-items: center; gap: 24px; margin-bottom: 32px; width: 100%;">
    <div class="page-desc" style="flex-shrink: 0;">Logs & Activity</div>
    <div class="header-actions">
        <button class="header-btn export" onclick="exportLogs()"><i class="fas fa-download"></i> Export CSV</button>
        <button class="header-btn refresh" onclick="refreshLogs()"><i class="fas fa-sync-alt"></i> Refresh</button>
    </div>
</div>

<!-- Stats Row -->
<div class="log-stats">
    <div class="log-stat"><div class="log-stat-icon all"><i class="fas fa-list"></i></div><div class="log-stat-info"><div class="log-stat-value" id="statAll">0</div><div class="log-stat-label">Total</div></div></div>
    <div class="log-stat"><div class="log-stat-icon trade"><i class="fas fa-exchange-alt"></i></div><div class="log-stat-info"><div class="log-stat-value" id="statTrade">0</div><div class="log-stat-label">Trades</div></div></div>
    <div class="log-stat"><div class="log-stat-icon copy"><i class="fas fa-copy"></i></div><div class="log-stat-info"><div class="log-stat-value" id="statCopy">0</div><div class="log-stat-label">Copied</div></div></div>
    <div class="log-stat"><div class="log-stat-icon error"><i class="fas fa-exclamation-triangle"></i></div><div class="log-stat-info"><div class="log-stat-value" id="statError">0</div><div class="log-stat-label">Errors</div></div></div>
    <div class="log-stat"><div class="log-stat-icon info"><i class="fas fa-info-circle"></i></div><div class="log-stat-info"><div class="log-stat-value" id="statInfo">0</div><div class="log-stat-label">Info</div></div></div>
</div>

<!-- Filters Bar -->
<div class="filters-bar">
    <div class="filter-group">
        <span class="filter-label">Log Type</span>
        <select class="filter-select" id="filterType" onchange="applyFilters()">
            <option value="">All Types</option>
            <option value="trade">Trades</option>
            <option value="copy">Copy Events</option>
            <option value="error">Errors</option>
            <option value="warning">Warnings</option>
            <option value="info">Info</option>
            <option value="system">System</option>
        </select>
    </div>
    <div class="filter-group">
        <span class="filter-label">Account</span>
        <select class="filter-select" id="filterAccount" onchange="applyFilters()">
            <option value="">All Accounts</option>
        </select>
    </div>
    <div class="filter-group">
        <span class="filter-label">Pair</span>
        <select class="filter-select" id="filterPair" onchange="applyFilters()">
            <option value="">All Pairs</option>
        </select>
    </div>
    <div class="filter-group" style="flex:1; min-width: 200px;">
        <span class="filter-label">Search</span>
        <input type="text" class="filter-input" id="filterSearch" placeholder="Search messages..." oninput="applyFilters()">
    </div>
    <button class="filter-btn clear" onclick="clearFilters()"><i class="fas fa-times"></i> Clear</button>
</div>

<!-- Log Container -->
<div class="log-container">
    <div class="log-header">
        <div class="log-title">Activity Log</div>
        <div class="log-header-right">
            <span class="log-count" id="logCount">0 entries</span>
            <div class="log-actions">
                <button class="log-action-btn active" id="autoScrollBtn" onclick="toggleAutoScroll()" title="Auto-scroll to top"><i class="fas fa-angle-double-down"></i></button>
            </div>
        </div>
    </div>
    <div class="log-list" id="logList">
        <div class="log-empty"><i class="fas fa-inbox"></i><h4>No Logs Yet</h4><p>Activity will appear here when the copier starts</p></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let allLogs = [];
let filteredLogs = [];
let autoScroll = true;
let accounts = new Set();
let pairs = new Set();

async function loadLogs() {
    try {
        const res = await fetch('/api/all-logs');
        const data = await res.json();
        allLogs = data.logs || [];
        allLogs.forEach(log => {
            if (log.account) accounts.add(log.account);
            if (log.pair) pairs.add(log.pair);
        });
        updateAccountFilter();
        updatePairFilter();
        updateStats();
        applyFilters();
    } catch(e) {
        console.error('Failed to load logs:', e);
        generateSampleLogs();
    }
}

function generateSampleLogs() {
    const types = ['trade', 'copy', 'info', 'error', 'warning', 'system'];
    const messages = {
        trade: ['Opened BUY 0.10 EURUSD @ 1.0856', 'Closed SELL 0.05 GBPUSD @ 1.2345 | Profit: +$12.50', 'Opened SELL 0.20 USDJPY @ 142.50'],
        copy: ['Copied trade from Master 12345 to Child 67890', 'Trade EURUSD copied with 1.5x multiplier', 'Position synced across 3 child accounts'],
        info: ['Copier started successfully', 'Connected to MT5 terminal', 'Monitoring 5 active positions'],
        error: ['Connection timeout to server', 'Invalid credentials for account 12345', 'Trade copy failed: Insufficient margin'],
        warning: ['High latency detected: 250ms', 'Account balance low: $50.00', 'Market closed for EURUSD'],
        system: ['Configuration loaded', 'Auto-restart enabled', 'Session initialized']
    };
    const pairList = ['EURUSD', 'GBPUSD', 'USDJPY', 'XAUUSD'];
    const accountList = ['12345', '67890', '11111'];

    allLogs = [];
    for (let i = 0; i < 45; i++) {
        const type = types[Math.floor(Math.random() * types.length)];
        const acc = accountList[Math.floor(Math.random() * accountList.length)];
        const pr = pairList[Math.floor(Math.random() * pairList.length)];
        allLogs.push({
            id: i, type: type,
            message: messages[type][Math.floor(Math.random() * messages[type].length)],
            timestamp: new Date(Date.now() - Math.random() * 7200000).toISOString(),
            account: acc,
            pair: pr
        });
        accounts.add(acc);
        pairs.add(pr);
    }
    allLogs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    updateAccountFilter();
    updatePairFilter();
    updateStats();
    applyFilters();
}

function updateAccountFilter() {
    const select = document.getElementById('filterAccount');
    const val = select.value;
    select.innerHTML = '<option value="">All Accounts</option>';
    [...accounts].sort().forEach(acc => { select.innerHTML += '<option value="' + acc + '">' + acc + '</option>'; });
    select.value = val;
}

function updatePairFilter() {
    const select = document.getElementById('filterPair');
    const val = select.value;
    select.innerHTML = '<option value="">All Pairs</option>';
    [...pairs].sort().forEach(p => { select.innerHTML += '<option value="' + p + '">' + p + '</option>'; });
    select.value = val;
}

function updateStats() {
    document.getElementById('statAll').textContent = allLogs.length;
    document.getElementById('statTrade').textContent = allLogs.filter(l => l.type === 'trade').length;
    document.getElementById('statCopy').textContent = allLogs.filter(l => l.type === 'copy').length;
    document.getElementById('statError').textContent = allLogs.filter(l => l.type === 'error' || l.type === 'warning').length;
    document.getElementById('statInfo').textContent = allLogs.filter(l => l.type === 'info' || l.type === 'system').length;
}

function applyFilters() {
    const type = document.getElementById('filterType').value;
    const account = document.getElementById('filterAccount').value;
    const pair = document.getElementById('filterPair').value;
    const search = document.getElementById('filterSearch').value.toLowerCase();

    filteredLogs = allLogs.filter(log => {
        if (type && log.type !== type) return false;
        if (account && log.account !== account) return false;
        if (pair && log.pair !== pair) return false;
        if (search && !log.message.toLowerCase().includes(search)) return false;
        return true;
    });
    renderLogs();
}

function clearFilters() {
    document.getElementById('filterType').value = '';
    document.getElementById('filterAccount').value = '';
    document.getElementById('filterPair').value = '';
    document.getElementById('filterSearch').value = '';
    applyFilters();
}

function renderLogs() {
    const list = document.getElementById('logList');
    document.getElementById('logCount').textContent = filteredLogs.length + ' entries';

    if (!filteredLogs.length) {
        list.innerHTML = '<div class="log-empty"><i class="fas fa-filter"></i><h4>No Matching Logs</h4><p>Try adjusting your filters</p></div>';
        return;
    }

    const icons = { trade: 'exchange-alt', copy: 'copy', error: 'exclamation-circle', warning: 'exclamation-triangle', info: 'info-circle', system: 'cog' };

    list.innerHTML = filteredLogs.map(log => {
        const time = new Date(log.timestamp);
        const timeStr = time.toLocaleTimeString('en-US', {hour12: false}) + '.' + String(time.getMilliseconds()).padStart(3, '0');
        const dateStr = time.toLocaleDateString('en-US', {month: 'short', day: 'numeric'});

        let msg = log.message || '';
        msg = msg.replace(/(BUY|SELL)/g, '<span class="highlight">$1</span>');
        msg = msg.replace(/(\d{5,})/g, '<span class="account">$1</span>');
        msg = msg.replace(/(EURUSD|GBPUSD|USDJPY|XAUUSD|BTCUSD)/g, '<span class="symbol">$1</span>');
        msg = msg.replace(/(error|failed|invalid|timeout)/gi, '<span class="error-text">$1</span>');

        return '<div class="log-item">' +
            '<div class="log-type-icon ' + log.type + '"><i class="fas fa-' + (icons[log.type] || 'circle') + '"></i></div>' +
            '<div class="log-content"><div class="log-message">' + msg + '</div>' +
            '<div class="log-meta">' + (log.account ? '<span class="log-meta-item"><i class="fas fa-user"></i> ' + log.account + '</span>' : '') +
            (log.pair ? '<span class="log-meta-item"><i class="fas fa-chart-line"></i> ' + log.pair + '</span>' : '') + '</div></div>' +
            '<div class="log-time">' + dateStr + '<br>' + timeStr + '</div></div>';
    }).join('');

    if (autoScroll) list.scrollTop = 0;
}

function toggleAutoScroll() {
    autoScroll = !autoScroll;
    document.getElementById('autoScrollBtn').classList.toggle('active', autoScroll);
}

function refreshLogs() { location.reload(); }

function exportLogs() {
    const csv = 'Timestamp,Type,Account,Pair,Message\n' +
        filteredLogs.map(l => '"' + (l.timestamp || '') + '","' + l.type + '","' + (l.account||'') + '","' + (l.pair||'') + '","' + (l.message || '').replace(/"/g, '""') + '"').join('\n');
    const blob = new Blob([csv], {type: 'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'logs_' + new Date().toISOString().split('T')[0] + '.csv';
    a.click();
}

loadLogs();
setInterval(loadLogs, 5000);
</script>
{% endblock %}

























