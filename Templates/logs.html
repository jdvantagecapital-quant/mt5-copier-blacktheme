{% extends "base.html" %}
{% block title %}Logs & Activity - MT5 Trade Copier{% endblock %}
{% block page_title %}<i class="fas fa-history"></i> Logs & Activity{% endblock %}

{% block extra_css %}
<style>
    /* Page Header */
    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .page-desc { font-size: 13px; color: var(--text-muted); }
    .header-actions { display: flex; gap: 10px; }
    .header-btn { padding: 10px 18px; border-radius: 8px; font-size: 11px; font-weight: 600; border: none; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s; }
    .header-btn.export { background: rgba(0,255,136,0.1); color: #00ff88; }
    .header-btn.export:hover { background: #00ff88; color: #000; }
    .header-btn.refresh { background: rgba(255,255,255,0.05); color: var(--text-secondary); }
    .header-btn.refresh:hover { background: rgba(255,255,255,0.1); color: #fff; }

    /* Stats Row - Horizontal */
    .log-stats { display: grid; grid-template-columns: repeat(5, 1fr); gap: 14px; margin-bottom: 20px; }
    .log-stat { display: flex; align-items: center; gap: 12px; padding: 16px 18px; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05); border-radius: 12px; }
    .log-stat-icon { width: 42px; height: 42px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0; }
    .log-stat-icon.all { background: rgba(255,255,255,0.08); color: #fff; }
    .log-stat-icon.trade { background: rgba(0,255,136,0.12); color: #00ff88; }
    .log-stat-icon.copy { background: rgba(0,170,255,0.12); color: #00aaff; }
    .log-stat-icon.error { background: rgba(255,51,102,0.12); color: #ff3366; }
    .log-stat-icon.info { background: rgba(255,170,0,0.12); color: #ffaa00; }
    .log-stat-info { flex: 1; }
    .log-stat-value { font-size: 22px; font-weight: 700; font-family: 'JetBrains Mono', monospace; line-height: 1; }
    .log-stat-label { font-size: 9px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-top: 4px; }

    /* Filters Bar - Horizontal */
    .filters-bar { display: flex; align-items: center; gap: 16px; padding: 16px 20px; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05); border-radius: 12px; margin-bottom: 20px; flex-wrap: nowrap; }
    .filter-group { display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
    .filter-label { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); white-space: nowrap; }
    .filter-select { padding: 10px 16px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; color: #fff; font-size: 12px; cursor: pointer; min-width: 140px; }
    .filter-select:focus { outline: none; border-color: #00aaff; }
    .filter-select option { background: #151515; color: #fff; }
    .filter-input { padding: 10px 16px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; color: #fff; font-size: 12px; min-width: 200px; flex: 1; }
    .filter-input:focus { outline: none; border-color: #00aaff; }
    .filter-input::placeholder { color: var(--text-muted); }
    .filter-btn { padding: 10px 16px; border-radius: 8px; font-size: 11px; font-weight: 600; border: none; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s; flex-shrink: 0; }
    .filter-btn.clear { background: rgba(255,255,255,0.05); color: var(--text-secondary); }
    .filter-btn.clear:hover { background: rgba(255,255,255,0.1); color: #fff; }

    /* Log Container */
    .log-container { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05); border-radius: 12px; overflow: hidden; }
    .log-header { padding: 16px 20px; border-bottom: 1px solid rgba(255,255,255,0.03); display: flex; justify-content: space-between; align-items: center; }
    .log-title { font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 2px; color: var(--text-muted); display: flex; align-items: center; gap: 10px; }
    .log-title::before { content: ''; width: 4px; height: 14px; background: linear-gradient(180deg, #00ff88, #00aaff); border-radius: 2px; }
    .log-count { font-size: 11px; padding: 5px 12px; background: rgba(255,255,255,0.05); border-radius: 12px; }
    .log-actions { display: flex; gap: 8px; }
    .log-action-btn { width: 34px; height: 34px; border-radius: 8px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; transition: all 0.2s; background: rgba(255,255,255,0.04); color: var(--text-muted); }
    .log-action-btn:hover { background: rgba(255,255,255,0.08); color: #fff; }
    .log-action-btn.active { background: rgba(0,255,136,0.12); color: #00ff88; }

    /* Log List */
    .log-list { max-height: 550px; overflow-y: auto; }
    .log-item { display: flex; align-items: flex-start; gap: 16px; padding: 16px 20px; border-bottom: 1px solid rgba(255,255,255,0.02); transition: all 0.15s; }
    .log-item:hover { background: rgba(255,255,255,0.02); }
    .log-item:last-child { border-bottom: none; }
    .log-type-icon { width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0; }
    .log-type-icon.trade { background: rgba(0,255,136,0.12); color: #00ff88; }
    .log-type-icon.copy { background: rgba(0,170,255,0.12); color: #00aaff; }
    .log-type-icon.error { background: rgba(255,51,102,0.12); color: #ff3366; }
    .log-type-icon.warning { background: rgba(255,170,0,0.12); color: #ffaa00; }
    .log-type-icon.info { background: rgba(170,102,255,0.12); color: #aa66ff; }
    .log-type-icon.system { background: rgba(255,255,255,0.06); color: var(--text-muted); }
    .log-content { flex: 1; min-width: 0; }
    .log-message { font-size: 13px; line-height: 1.5; margin-bottom: 8px; word-break: break-word; }
    .log-message .highlight { color: #00ff88; font-weight: 600; }
    .log-message .account { color: #00aaff; font-family: 'JetBrains Mono', monospace; }
    .log-message .symbol { color: #ffaa00; font-weight: 600; }
    .log-message .error-text { color: #ff3366; }
    .log-meta { display: flex; flex-wrap: wrap; gap: 12px; font-size: 11px; color: var(--text-muted); }
    .log-meta-item { display: flex; align-items: center; gap: 5px; }
    .log-meta-item i { font-size: 10px; opacity: 0.6; }
    .log-time { font-size: 11px; color: var(--text-muted); white-space: nowrap; font-family: 'JetBrains Mono', monospace; flex-shrink: 0; }

    /* Empty Log */
    .log-empty { padding: 80px 20px; text-align: center; }
    .log-empty i { font-size: 48px; opacity: 0.1; margin-bottom: 16px; }
    .log-empty h4 { font-size: 16px; margin-bottom: 8px; }
    .log-empty p { font-size: 12px; color: var(--text-muted); }

    /* Scrollbar */
    .log-list::-webkit-scrollbar { width: 6px; }
    .log-list::-webkit-scrollbar-track { background: rgba(255,255,255,0.02); }
    .log-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
    .log-list::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.15); }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <div class="page-desc">View and filter all trade history, errors, and system events</div>
    <div class="header-actions">
        <button class="header-btn export" onclick="exportLogs()"><i class="fas fa-download"></i> Export CSV</button>
        <button class="header-btn refresh" onclick="refreshLogs()"><i class="fas fa-sync-alt"></i> Refresh</button>
    </div>
</div>

<!-- Stats Row - Horizontal -->
<div class="log-stats">
    <div class="log-stat"><div class="log-stat-icon all"><i class="fas fa-list"></i></div><div class="log-stat-info"><div class="log-stat-value" id="statAll">0</div><div class="log-stat-label">Total</div></div></div>
    <div class="log-stat"><div class="log-stat-icon trade"><i class="fas fa-exchange-alt"></i></div><div class="log-stat-info"><div class="log-stat-value" id="statTrade">0</div><div class="log-stat-label">Trades</div></div></div>
    <div class="log-stat"><div class="log-stat-icon copy"><i class="fas fa-copy"></i></div><div class="log-stat-info"><div class="log-stat-value" id="statCopy">0</div><div class="log-stat-label">Copied</div></div></div>
    <div class="log-stat"><div class="log-stat-icon error"><i class="fas fa-exclamation-triangle"></i></div><div class="log-stat-info"><div class="log-stat-value" id="statError">0</div><div class="log-stat-label">Errors</div></div></div>
    <div class="log-stat"><div class="log-stat-icon info"><i class="fas fa-info-circle"></i></div><div class="log-stat-info"><div class="log-stat-value" id="statInfo">0</div><div class="log-stat-label">Info</div></div></div>
</div>

<!-- Filters Bar - Horizontal -->
<div class="filters-bar">
    <div class="filter-group">
        <span class="filter-label">Type</span>
        <select class="filter-select" id="filterType" onchange="applyFilters()">
            <option value="">All Types</option>
            <option value="trade">Trades</option>
            <option value="copy">Copy Events</option>
            <option value="error">Errors</option>
            <option value="warning">Warnings</option>
            <option value="info">Info</option>
            <option value="system">System</option>
        </select>
    </div>
    <div class="filter-group">
        <span class="filter-label">Account</span>
        <select class="filter-select" id="filterAccount" onchange="applyFilters()">
            <option value="">All Accounts</option>
        </select>
    </div>
    <div class="filter-group" style="flex:1;">
        <span class="filter-label">Search</span>
        <input type="text" class="filter-input" id="filterSearch" placeholder="Search in logs..." oninput="applyFilters()">
    </div>
    <button class="filter-btn clear" onclick="clearFilters()"><i class="fas fa-times"></i> Clear</button>
</div>

<!-- Log Container -->
<div class="log-container">
    <div class="log-header">
        <div class="log-title">Activity Log</div>
        <div style="display:flex;align-items:center;gap:16px;">
            <span class="log-count" id="logCount">0 entries</span>
            <div class="log-actions">
                <button class="log-action-btn active" id="autoScrollBtn" onclick="toggleAutoScroll()" title="Auto-scroll"><i class="fas fa-angle-double-down"></i></button>
            </div>
        </div>
    </div>
    <div class="log-list" id="logList">
        <div class="log-empty"><i class="fas fa-inbox"></i><h4>No Logs Yet</h4><p>Activity will appear here when the copier starts</p></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let allLogs = [];
let filteredLogs = [];
let autoScroll = true;
let accounts = new Set();

async function loadLogs() {
    try {
        const res = await fetch('/api/all-logs');
        const data = await res.json();
        allLogs = data.logs || [];
        allLogs.forEach(log => { if (log.account) accounts.add(log.account); });
        updateAccountFilter();
        updateStats();
        applyFilters();
    } catch(e) { 
        console.error(e);
        generateSampleLogs();
    }
}

function generateSampleLogs() {
    const types = ['trade', 'copy', 'info', 'error', 'warning', 'system'];
    const messages = {
        trade: ['Opened BUY 0.10 EURUSD @ 1.0856', 'Closed SELL 0.05 GBPUSD @ 1.2345 | Profit: +$12.50', 'Opened SELL 0.20 USDJPY @ 142.50'],
        copy: ['Copied trade from Master 12345 to Child 67890', 'Trade EURUSD copied with 1.5x multiplier', 'Position synced across 3 child accounts'],
        info: ['Copier started successfully', 'Connected to MT5 terminal', 'Monitoring 5 active positions'],
        error: ['Connection timeout to server', 'Invalid credentials for account 12345', 'Trade copy failed: Insufficient margin'],
        warning: ['High latency detected: 250ms', 'Account balance low: $50.00', 'Market closed for EURUSD'],
        system: ['Configuration loaded', 'Auto-restart enabled', 'Session initialized']
    };
    
    allLogs = [];
    for (let i = 0; i < 30; i++) {
        const type = types[Math.floor(Math.random() * types.length)];
        allLogs.push({
            id: i, type: type,
            message: messages[type][Math.floor(Math.random() * messages[type].length)],
            timestamp: new Date(Date.now() - Math.random() * 3600000).toISOString(),
            account: ['12345', '67890', '11111'][Math.floor(Math.random() * 3)],
            pair: ['EURUSD', 'GBPUSD', 'USDJPY'][Math.floor(Math.random() * 3)]
        });
    }
    allLogs.forEach(l => accounts.add(l.account));
    allLogs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    updateAccountFilter();
    updateStats();
    applyFilters();
}

function updateAccountFilter() {
    const select = document.getElementById('filterAccount');
    const val = select.value;
    select.innerHTML = '<option value="">All Accounts</option>';
    accounts.forEach(acc => { select.innerHTML += '<option value="' + acc + '">' + acc + '</option>'; });
    select.value = val;
}

function updateStats() {
    document.getElementById('statAll').textContent = allLogs.length;
    document.getElementById('statTrade').textContent = allLogs.filter(l => l.type === 'trade').length;
    document.getElementById('statCopy').textContent = allLogs.filter(l => l.type === 'copy').length;
    document.getElementById('statError').textContent = allLogs.filter(l => l.type === 'error' || l.type === 'warning').length;
    document.getElementById('statInfo').textContent = allLogs.filter(l => l.type === 'info' || l.type === 'system').length;
}

function applyFilters() {
    const type = document.getElementById('filterType').value;
    const account = document.getElementById('filterAccount').value;
    const search = document.getElementById('filterSearch').value.toLowerCase();
    
    filteredLogs = allLogs.filter(log => {
        if (type && log.type !== type) return false;
        if (account && log.account !== account) return false;
        if (search && !log.message.toLowerCase().includes(search)) return false;
        return true;
    });
    renderLogs();
}

function clearFilters() {
    document.getElementById('filterType').value = '';
    document.getElementById('filterAccount').value = '';
    document.getElementById('filterSearch').value = '';
    applyFilters();
}

function renderLogs() {
    const list = document.getElementById('logList');
    document.getElementById('logCount').textContent = filteredLogs.length + ' entries';
    
    if (!filteredLogs.length) {
        list.innerHTML = '<div class="log-empty"><i class="fas fa-filter"></i><h4>No Matching Logs</h4><p>Try adjusting your filters</p></div>';
        return;
    }
    
    const icons = { trade: 'exchange-alt', copy: 'copy', error: 'exclamation-circle', warning: 'exclamation-triangle', info: 'info-circle', system: 'cog' };
    
    list.innerHTML = filteredLogs.map(log => {
        const time = new Date(log.timestamp);
        const timeStr = time.toLocaleTimeString('en-US', {hour12: false}) + '.' + String(time.getMilliseconds()).padStart(3, '0');
        const dateStr = time.toLocaleDateString('en-US', {month: 'short', day: 'numeric'});
        
        let msg = log.message;
        msg = msg.replace(/(BUY|SELL)/g, '<span class="highlight">$1</span>');
        msg = msg.replace(/(\d{5,})/g, '<span class="account">$1</span>');
        msg = msg.replace(/(EURUSD|GBPUSD|USDJPY|XAUUSD|BTCUSD)/g, '<span class="symbol">$1</span>');
        msg = msg.replace(/(error|failed|invalid|timeout)/gi, '<span class="error-text">$1</span>');
        
        return '<div class="log-item">' +
            '<div class="log-type-icon ' + log.type + '"><i class="fas fa-' + (icons[log.type] || 'circle') + '"></i></div>' +
            '<div class="log-content"><div class="log-message">' + msg + '</div>' +
            '<div class="log-meta">' + (log.account ? '<span class="log-meta-item"><i class="fas fa-user"></i> ' + log.account + '</span>' : '') +
            (log.pair ? '<span class="log-meta-item"><i class="fas fa-chart-line"></i> ' + log.pair + '</span>' : '') + '</div></div>' +
            '<div class="log-time">' + dateStr + '<br>' + timeStr + '</div></div>';
    }).join('');
    
    if (autoScroll) list.scrollTop = 0;
}

function toggleAutoScroll() {
    autoScroll = !autoScroll;
    document.getElementById('autoScrollBtn').classList.toggle('active', autoScroll);
}

function refreshLogs() { loadLogs(); }

function exportLogs() {
    const csv = 'Timestamp,Type,Account,Pair,Message\n' + 
        filteredLogs.map(l => '"' + l.timestamp + '","' + l.type + '","' + (l.account||'') + '","' + (l.pair||'') + '","' + l.message.replace(/"/g, '""') + '"').join('\n');
    const blob = new Blob([csv], {type: 'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'logs_' + new Date().toISOString().split('T')[0] + '.csv';
    a.click();
}

loadLogs();
setInterval(loadLogs, 5000);
</script>
{% endblock %}
