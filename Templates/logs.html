{% extends "base.html" %}
{% block title %}Logs & Activity - MT5 Trade Copier{% endblock %}
{% block page_title %}<i class="fas fa-terminal"></i> Logs & Activity{% endblock %}

{% block extra_css %}
<style>
    .page-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; }
    .page-title { font-size: 14px; font-weight: 700; color: #888; text-transform: uppercase; letter-spacing: 1px; }
    .header-actions { display: flex; gap: 10px; }
    .add-btn { padding: 10px 18px; background: var(--bg-card, #fff); color: var(--text-secondary, #666); border: 1px solid var(--border, #e5e7eb); border-radius: 999px; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s; }
    .add-btn:hover { border-color: var(--border-hover, #ccc); color: var(--text-primary, #333); background: var(--bg-hover, #f9fafb); }
    
    .log-stats { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-bottom: 20px; }
    @media (max-width: 900px) { .log-stats { grid-template-columns: repeat(3, 1fr); } }
    .log-stat { background: #fff; border: 1px solid #e5e7eb; border-radius: 10px; padding: 14px; display: flex; align-items: center; gap: 12px; }
    .log-stat-icon { width: 38px; height: 38px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 14px; }
    .log-stat-icon.total { background: rgba(102,126,234,0.15); color: #667eea; }
    .log-stat-icon.trades { background: rgba(0,200,100,0.15); color: #00c864; }
    .log-stat-icon.copied { background: rgba(0,136,204,0.15); color: #0088cc; }
    .log-stat-icon.errors { background: rgba(255,68,102,0.15); color: #ff4466; }
    .log-stat-icon.info { background: rgba(204,136,0,0.15); color: #cc8800; }
    .log-stat-value { font-size: 20px; font-weight: 700; font-family: 'JetBrains Mono', monospace; color: #333; }
    .log-stat-label { font-size: 10px; color: #666; text-transform: uppercase; }
    
    .filters-bar { display: flex; align-items: center; gap: 12px; padding: 14px 16px; background: #fff; border: 1px solid #e5e7eb; border-radius: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .filter-group { display: flex; align-items: center; gap: 8px; }
    .filter-label { font-size: 9px; font-weight: 600; text-transform: uppercase; color: #666; }
    .filter-select { padding: 8px 10px; background: #fff; border: 1px solid #d1d5db; border-radius: 6px; color: #333; font-size: 11px; min-width: 120px; }
    .filter-input { padding: 8px 10px; background: #fff; border: 1px solid #d1d5db; border-radius: 6px; color: #333; font-size: 11px; flex: 1; min-width: 140px; }
    .filter-btn { padding: 8px 12px; border-radius: 6px; font-size: 10px; font-weight: 600; cursor: pointer; border: 1px solid #d1d5db; background: #fff; color: #666; }
    .filter-btn:hover { background: #f3f4f6; color: #333; }
    
    .log-container { background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden; }
    .log-header { padding: 14px 16px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; background: #f9fafb; }
    .log-title { font-size: 12px; font-weight: 600; color: #666; display: flex; align-items: center; gap: 8px; }
    .log-title i { color: #667eea; }
    .log-count { font-size: 10px; padding: 4px 10px; background: rgba(102,126,234,0.1); border: 1px solid rgba(102,126,234,0.2); border-radius: 12px; color: #667eea; font-weight: 600; }
    .log-actions { display: flex; gap: 8px; align-items: center; }
    .auto-btn { padding: 6px 14px; border-radius: 6px; border: 1px solid #d1d5db; cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 11px; background: #fff; color: #666; font-weight: 600; }
    .auto-btn:hover { background: #f3f4f6; color: #333; }
    .auto-btn.active { background: rgba(0,200,100,0.1); border-color: rgba(0,200,100,0.3); color: #00c864; }
    
    .log-list { max-height: 500px; overflow-y: auto; }
    .log-item { display: flex; align-items: flex-start; gap: 12px; padding: 12px 16px; border-bottom: 1px solid #f3f4f6; }
    .log-item:hover { background: rgba(102,126,234,0.03); }
    .log-type-icon { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 12px; flex-shrink: 0; }
    .log-type-icon.trade, .log-type-icon.open { background: rgba(0,200,100,0.15); color: #00c864; }
    .log-type-icon.close { background: rgba(139,92,246,0.15); color: #8b5cf6; }
    .log-type-icon.copy { background: rgba(0,136,204,0.15); color: #0088cc; }
    .log-type-icon.error { background: rgba(255,68,102,0.15); color: #ff4466; }
    .log-type-icon.warning { background: rgba(245,158,11,0.15); color: #f59e0b; }
    .log-type-icon.info { background: rgba(59,130,246,0.15); color: #3b82f6; }
    .log-type-icon.signal { background: rgba(204,136,0,0.15); color: #cc8800; }
    .log-type-icon.system { background: rgba(100,116,139,0.15); color: #94a3b8; }
    .log-content { flex: 1; min-width: 0; }
    .log-message { font-size: 12px; line-height: 1.5; margin-bottom: 6px; color: #333; word-break: break-word; }
    .log-message .highlight { color: #00c864; font-weight: 600; }
    .log-message .account { color: #0088cc; font-family: 'JetBrains Mono', monospace; }
    .log-message .symbol { color: #cc8800; font-weight: 600; }
    .log-message .error-text { color: #ff4466; }
    .log-meta { display: flex; flex-wrap: wrap; gap: 12px; font-size: 10px; color: #666; }
    .log-meta-item { display: flex; align-items: center; gap: 4px; }
    .log-meta-item i { font-size: 9px; opacity: 0.6; }
    .log-time { font-size: 10px; color: #666; white-space: nowrap; font-family: 'JetBrains Mono', monospace; flex-shrink: 0; text-align: right; }
    
    .log-empty { padding: 60px 20px; text-align: center; }
    .log-empty i { font-size: 36px; color: #d1d5db; margin-bottom: 12px; }
    .log-empty h4 { font-size: 14px; color: #666; margin-bottom: 4px; }
    .log-empty p { font-size: 11px; color: #999; }
</style>
{% endblock %}
{% block content %}
<div class="page-header" style="display: flex; justify-content: space-between; align-items: center; gap: 24px; margin-bottom: 32px; width: 100%;">
    <div class="page-title" style="flex-shrink: 0;">Activity Log</div>
    <div class="header-actions">
        <button class="add-btn" onclick="exportLogs()" style="background: rgba(102,126,234,0.1); color: #667eea; border-color: rgba(102,126,234,0.3);"><i class="fas fa-download"></i> Export</button>
        <button class="add-btn" onclick="refreshLogs()"><i class="fas fa-sync-alt"></i> Refresh</button>
    </div>
</div>

<div class="log-stats">
    <div class="log-stat"><div class="log-stat-icon total"><i class="fas fa-list"></i></div><div><div class="log-stat-value" id="statAll">0</div><div class="log-stat-label">Total</div></div></div>
    <div class="log-stat"><div class="log-stat-icon trades"><i class="fas fa-arrow-up"></i></div><div><div class="log-stat-value" id="statTrade">0</div><div class="log-stat-label">Trades</div></div></div>
    <div class="log-stat"><div class="log-stat-icon copied"><i class="fas fa-copy"></i></div><div><div class="log-stat-value" id="statCopy">0</div><div class="log-stat-label">Copied</div></div></div>
    <div class="log-stat"><div class="log-stat-icon errors"><i class="fas fa-exclamation-triangle"></i></div><div><div class="log-stat-value" id="statError">0</div><div class="log-stat-label">Errors</div></div></div>
    <div class="log-stat"><div class="log-stat-icon info"><i class="fas fa-info-circle"></i></div><div><div class="log-stat-value" id="statInfo">0</div><div class="log-stat-label">Info</div></div></div>
</div>

<div class="filters-bar">
    <div class="filter-group"><span class="filter-label">Type</span><select class="filter-select" id="filterType" onchange="applyFilters()"><option value="">All</option><option value="trade">Trade/Open</option><option value="close">Close</option><option value="copy">Copied</option><option value="error">Error</option><option value="warning">Warning</option><option value="info">Info</option></select></div>
    <div class="filter-group"><span class="filter-label">Account</span><select class="filter-select" id="filterAccount" onchange="applyFilters()"><option value="">All</option></select></div>
    <div class="filter-group"><span class="filter-label">Pair</span><select class="filter-select" id="filterPair" onchange="applyFilters()"><option value="">All</option></select></div>
    <div class="filter-group" style="flex:1;"><input type="text" class="filter-input" id="filterSearch" placeholder="Search logs..." oninput="applyFilters()"></div>
    <button class="filter-btn" onclick="clearFilters()"><i class="fas fa-times"></i> Clear</button>
</div>

<div class="log-container">
    <div class="log-header">
        <div class="log-title"><i class="fas fa-terminal"></i> Live Feed</div>
        <div class="log-actions">
            <span class="log-count" id="logCount">0 entries</span>
            <button class="auto-btn active" id="autoScrollBtn" onclick="toggleAutoScroll()" title="Auto-scroll"><i class="fas fa-sync-alt"></i> Auto</button>
        </div>
    </div>
    <div class="log-list" id="logList"><div class="log-empty"><i class="fas fa-inbox"></i><h4>Loading...</h4><p>Fetching activity logs</p></div></div>
</div>
{% endblock %}
{% block extra_js %}
<script>
let allLogs = [], filteredLogs = [], autoScroll = true;
let accounts = new Set(), pairs = new Set();

function normalizeType(log) {
    const t = (log.type || log.action || 'info').toLowerCase();
    const msg = (log.message || '').toLowerCase();
    if (t === 'trade' || t === 'open' || msg.includes('opened') || msg.includes('open trade') || msg.includes('buy') || msg.includes('sell')) return 'trade';
    if (t === 'close' || msg.includes('closed') || msg.includes('close trade')) return 'close';
    if (t === 'copy' || msg.includes('copied') || msg.includes('copy')) return 'copy';
    if (t === 'signal' || msg.includes('signal')) return 'signal';
    if (t === 'error' || msg.includes('error') || msg.includes('failed')) return 'error';
    if (t === 'warning' || msg.includes('warning')) return 'warning';
    return 'info';
}

async function loadLogs() {
    try {
        const res = await fetch('/api/all-logs?limit=500');
        const data = await res.json();
        allLogs = data.logs || [];
        accounts.clear(); pairs.clear();
        allLogs.forEach(log => {
            if (log.account) accounts.add(log.account);
            if (log.symbol) pairs.add(log.symbol);
            if (log.pair_name) pairs.add(log.pair_name);
        });
        updateFilters();
        applyFilters();
    } catch(e) {
        console.error('Failed to load logs:', e);
        document.getElementById('logList').innerHTML = '<div class="log-empty"><i class="fas fa-exclamation-triangle"></i><h4>Error</h4><p>Failed to load logs</p></div>';
    }
}

function updateFilters() {
    const accSelect = document.getElementById('filterAccount');
    const pairSelect = document.getElementById('filterPair');
    const accVal = accSelect.value, pairVal = pairSelect.value;
    accSelect.innerHTML = '<option value="">All</option>';
    pairSelect.innerHTML = '<option value="">All</option>';
    [...accounts].sort().forEach(a => accSelect.innerHTML += '<option value="'+a+'">'+a+'</option>');
    [...pairs].sort().forEach(p => pairSelect.innerHTML += '<option value="'+p+'">'+p+'</option>');
    accSelect.value = accVal; pairSelect.value = pairVal;
}

function updateStats() {
    document.getElementById('statAll').textContent = filteredLogs.length;
    document.getElementById('statTrade').textContent = filteredLogs.filter(l => normalizeType(l) === 'trade').length;
    document.getElementById('statCopy').textContent = filteredLogs.filter(l => normalizeType(l) === 'copy' || (l.message||'').toLowerCase().includes('copied')).length;
    document.getElementById('statError').textContent = filteredLogs.filter(l => ['error','warning'].includes(normalizeType(l))).length;
    document.getElementById('statInfo').textContent = filteredLogs.filter(l => normalizeType(l) === 'info').length;
}

function applyFilters() {
    const type = document.getElementById('filterType').value.toLowerCase();
    const account = document.getElementById('filterAccount').value;
    const pair = document.getElementById('filterPair').value;
    const search = document.getElementById('filterSearch').value.toLowerCase();
    
    filteredLogs = allLogs.filter(log => {
        const logType = normalizeType(log);
        if (type && logType !== type) return false;
        if (account && log.account !== account) return false;
        if (pair && log.symbol !== pair && log.pair_name !== pair) return false;
        if (search && !(log.message||'').toLowerCase().includes(search)) return false;
        return true;
    });
    renderLogs();
    updateStats();
}

function clearFilters() {
    document.getElementById('filterType').value = '';
    document.getElementById('filterAccount').value = '';
    document.getElementById('filterPair').value = '';
    document.getElementById('filterSearch').value = '';
    applyFilters();
}

function renderLogs() {
    const list = document.getElementById('logList');
    document.getElementById('logCount').textContent = filteredLogs.length + ' entries';
    
    if (!filteredLogs.length) {
        list.innerHTML = '<div class="log-empty"><i class="fas fa-filter"></i><h4>No Logs Found</h4><p>Try adjusting filters</p></div>';
        return;
    }
    
    const icons = { trade:'arrow-up', open:'arrow-up', close:'arrow-down', copy:'copy', error:'exclamation-circle', warning:'exclamation-triangle', info:'info-circle', signal:'bolt', system:'cog' };
    
    list.innerHTML = filteredLogs.map(log => {
        const type = normalizeType(log);
        let timeStr = log.timestamp || '';
        let dateStr = '';
        if (timeStr) {
            const parts = timeStr.split(' ');
            dateStr = parts[0] || '';
            timeStr = parts[1] || parts[0] || '';
        }
        
        let msg = log.message || '';
        msg = msg.replace(/(BUY|SELL|OPENED|CLOSED|COPIED)/gi, '<span class="highlight">$1</span>');
        msg = msg.replace(/(\d{5,})/g, '<span class="account">$1</span>');
        msg = msg.replace(/(EURUSD|GBPUSD|USDJPY|XAUUSD|BTCUSD|[A-Z]{6})/g, '<span class="symbol">$1</span>');
        msg = msg.replace(/(error|failed|invalid|timeout)/gi, '<span class="error-text">$1</span>');
        
        return '<div class="log-item"><div class="log-type-icon '+type+'"><i class="fas fa-'+(icons[type]||'circle')+'"></i></div>' +
            '<div class="log-content"><div class="log-message">'+msg+'</div>' +
            '<div class="log-meta">'+(log.account ? '<span class="log-meta-item"><i class="fas fa-user"></i> '+log.account+'</span>' : '') +
            (log.account_type ? '<span class="log-meta-item"><i class="fas fa-tag"></i> '+log.account_type+'</span>' : '') +
            (log.symbol ? '<span class="log-meta-item"><i class="fas fa-chart-line"></i> '+log.symbol+'</span>' : '') +
            (log.ticket ? '<span class="log-meta-item"><i class="fas fa-ticket-alt"></i> '+log.ticket+'</span>' : '') +
            '</div></div><div class="log-time">'+dateStr+'<br>'+timeStr+'</div></div>';
    }).join('');
    
    if (autoScroll) list.scrollTop = 0;
}

function toggleAutoScroll() {
    autoScroll = !autoScroll;
    document.getElementById('autoScrollBtn').classList.toggle('active', autoScroll);
}

function refreshLogs() { loadLogs(); if (typeof showToast === 'function') showToast('success', 'Refreshed', 'Logs updated'); }

function exportLogs() {
    if (!filteredLogs.length) { if (typeof showToast === 'function') showToast('warning', 'No data', 'No logs to export'); return; }
    const csv = 'Timestamp,Type,Account,Symbol,Message\n' + filteredLogs.map(l => '"'+(l.timestamp||'')+'","'+normalizeType(l)+'","'+(l.account||'')+'","'+(l.symbol||'')+'","'+((l.message||'').replace(/"/g,'""'))+'"').join('\n');
    const blob = new Blob([csv], {type:'text/csv'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'logs_'+new Date().toISOString().split('T')[0]+'.csv'; a.click();
}

loadLogs();
setInterval(loadLogs, 5000);
</script>
{% endblock %}
