{% extends "base.html" %}
{% block title %}History - MT5 Trade Copier{% endblock %}
{% block page_title %}<i class="fas fa-history"></i> Trade History{% endblock %}

{% block extra_css %}
<style>
    .history-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; }
    .add-btn { padding: 10px 18px; background: var(--bg-card); color: var(--text-secondary); border: 1px solid var(--border); border-radius: 999px; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s; }
    .add-btn:hover { border-color: var(--border-hover); color: var(--text-primary); background: var(--bg-hover); }
    .history-title { font-size: 14px; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; }
    .history-actions { display: flex; gap: 10px; }
    
    .filters-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 20px; }
    .filters-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; cursor: pointer; }
    .filters-title { font-size: 12px; font-weight: 600; color: var(--text-secondary); display: flex; align-items: center; gap: 8px; }
    .filters-title i { color: #cc8800; }
    .filters-toggle { color: var(--text-secondary); transition: transform 0.2s; }
    .filters-header.collapsed .filters-toggle { transform: rotate(-180deg); }
    .filters-body { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; }
    .filters-body.collapsed { display: none; }
    .filter-group { display: flex; flex-direction: column; gap: 4px; }
    .filter-label { font-size: 10px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
    .filter-select, .filter-input { padding: 8px 10px; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-size: 11px; }
    .filter-select:focus, .filter-input:focus { outline: none; border-color: #cc8800; }
    .filter-select option { background: var(--bg-card); color: var(--text-primary); }
    .filter-actions { display: flex; gap: 8px; align-items: flex-end; }
    
    .stats-row { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-bottom: 20px; }
    @media (max-width: 900px) { .stats-row { grid-template-columns: repeat(3, 1fr); } }
    @media (max-width: 600px) { .stats-row { grid-template-columns: repeat(2, 1fr); } }
    .mini-stat { background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; padding: 14px; display: flex; align-items: center; gap: 12px; }
    .mini-stat-icon { width: 38px; height: 38px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 14px; }
    .mini-stat-icon.total { background: rgba(102,126,234,0.15); color: #667eea; }
    .mini-stat-icon.trades { background: rgba(0,200,100,0.15); color: #00c864; }
    .mini-stat-icon.copied { background: rgba(0,136,204,0.15); color: #0088cc; }
    .mini-stat-icon.errors { background: rgba(255,68,102,0.15); color: #ff4466; }
    .mini-stat-icon.info { background: rgba(204,136,0,0.15); color: #cc8800; }
    .mini-stat-content .value { font-size: 20px; font-weight: 700; font-family: 'JetBrains Mono', monospace; color: var(--text-primary); }
    .mini-stat-content .label { font-size: 10px; color: var(--text-secondary); text-transform: uppercase; }
    
    .history-table-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
    .table-header { padding: 14px 16px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; background: var(--bg-elevated); }
    .table-title { font-size: 12px; font-weight: 600; color: var(--text-secondary); display: flex; align-items: center; gap: 8px; }
    .table-title i { color: #0088cc; }
    .table-count { padding: 3px 10px; background: rgba(0,136,204,0.1); color: #0088cc; border-radius: 12px; font-size: 10px; font-weight: 700; border: 1px solid rgba(0,136,204,0.2); }
    .table-actions { display: flex; gap: 6px; }
    .table-action-btn { padding: 6px 10px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; color: var(--text-secondary); font-size: 10px; cursor: pointer; display: flex; align-items: center; gap: 5px; }
    .table-action-btn:hover { background: var(--bg-hover); color: var(--text-primary); }
    
    .table-container { max-height: 500px; overflow-y: auto; }
    table { width: 100%; border-collapse: collapse; }
    th { padding: 10px 14px; text-align: left; font-size: 9px; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; background: var(--bg-elevated); border-bottom: 1px solid var(--border); position: sticky; top: 0; }
    td { padding: 10px 14px; border-bottom: 1px solid var(--border); font-size: 11px; color: var(--text-primary); }
    tr:hover { background: var(--bg-hover); }
    
    .log-level { padding: 2px 6px; border-radius: 3px; font-size: 8px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
    .log-level.trade { background: rgba(0,200,100,0.2); color: #00c864; }
    .log-level.open { background: rgba(0,200,100,0.2); color: #00c864; }
    .log-level.close { background: rgba(139,92,246,0.2); color: #8b5cf6; }
    .log-level.modify { background: rgba(245,158,11,0.2); color: #f59e0b; }
    .log-level.copy { background: rgba(0,136,204,0.2); color: #0088cc; }
    .log-level.info { background: rgba(59,130,246,0.2); color: #3b82f6; }
    .log-level.warning { background: rgba(245,158,11,0.2); color: #f59e0b; }
    .log-level.error { background: rgba(255,68,102,0.2); color: #ff4466; }
    .log-level.debug { background: rgba(100,116,139,0.2); color: #94a3b8; }
    .log-level.signal { background: rgba(204,136,0,0.2); color: #cc8800; }
    
    .account-badge { font-size: 8px; padding: 2px 5px; border-radius: 3px; font-weight: 600; }
    .account-badge.master { background: rgba(204,136,0,0.15); color: #cc8800; }
    .account-badge.child { background: rgba(0,136,204,0.15); color: #0088cc; }
    .account-badge.system { background: rgba(100,116,139,0.15); color: #94a3b8; }
    
    .symbol-badge { display: inline-flex; align-items: center; gap: 4px; font-weight: 500; font-size: 10px; color: var(--text-primary); }
    .symbol-badge i { color: #667eea; font-size: 10px; }
    
    .expand-row { cursor: pointer; }
    .expand-row td:first-child::before { content: '\f054'; font-family: 'Font Awesome 6 Free'; font-weight: 900; margin-right: 8px; font-size: 8px; color: var(--text-muted); transition: transform 0.2s; display: inline-block; }
    .expand-row.expanded td:first-child::before { transform: rotate(90deg); }
    .detail-row { display: none; }
    .detail-row.show { display: table-row; }
    .detail-row td { padding: 0; background: var(--bg-elevated); }
    .detail-content { padding: 14px; }
    .detail-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; }
    .detail-item { display: flex; flex-direction: column; gap: 2px; }
    .detail-label { font-size: 9px; color: var(--text-muted); text-transform: uppercase; }
    .detail-value { font-size: 11px; font-weight: 500; font-family: 'JetBrains Mono', monospace; color: var(--text-primary); }
    
    .pagination { padding: 12px 16px; border-top: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
    .pagination-info { font-size: 10px; color: var(--text-secondary); }
    .pagination-btns { display: flex; gap: 4px; }
    .page-btn { width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; color: var(--text-secondary); font-size: 10px; cursor: pointer; }
    .page-btn:hover:not(:disabled) { background: var(--bg-hover); color: var(--text-primary); }
    .page-btn.active { background: #667eea; border-color: #667eea; color: #fff; }
    .page-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    
    .empty-table { padding: 40px 16px; text-align: center; }
    .empty-table i { font-size: 36px; color: var(--text-muted); margin-bottom: 12px; }
    .empty-table h3 { font-size: 14px; color: var(--text-secondary); margin-bottom: 4px; }
    .empty-table p { font-size: 11px; color: var(--text-muted); }
    
    .btn-sm { padding: 6px 12px; font-size: 10px; font-weight: 600; border-radius: 6px; cursor: pointer; display: inline-flex; align-items: center; gap: 5px; border: 1px solid; }
    .btn-secondary { background: var(--bg-card); color: var(--text-secondary); border-color: var(--border); }
    .btn-secondary:hover { background: var(--bg-hover); color: var(--text-primary); }
    .btn-primary { background: rgba(102,126,234,0.1); color: #667eea; border-color: rgba(102,126,234,0.3); }
    .btn-primary:hover { background: rgba(102,126,234,0.2); }
    
    /* Date input styling for both themes */
    .filter-input[type="date"] { -webkit-appearance: none; }
    .filter-input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(0.5); cursor: pointer; }
    html[data-theme="light"] .filter-input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(0); }

    /* Light theme comprehensive fixes */
    html[data-theme="light"] .filters-card { background: #ffffff; border-color: #d0d2d7; }
    html[data-theme="light"] .history-table-card { background: #ffffff; border-color: #d0d2d7; }
    html[data-theme="light"] .table-header { background: #f5f6f7; }
    html[data-theme="light"] th { background: #f5f6f7; color: #555; }
    html[data-theme="light"] td { color: #333; border-color: #e5e7eb; }
    html[data-theme="light"] tr:hover { background: #f0f1f3; }
    html[data-theme="light"] .mini-stat { background: #ffffff; border-color: #d0d2d7; }
    html[data-theme="light"] .filter-select, html[data-theme="light"] .filter-input { background: #ffffff; border-color: #d0d2d7; color: #333; }
    html[data-theme="light"] .detail-row td { background: #f5f6f7; }
    html[data-theme="light"] .page-btn { background: #ffffff; border-color: #d0d2d7; color: #555; }
    html[data-theme="light"] .page-btn:hover:not(:disabled) { background: #f0f1f3; }
</style>
{% endblock %}

{% block content %}
<div class="page-header" style="display: flex; justify-content: space-between; align-items: center; gap: 24px; margin-bottom: 32px; width: 100%;">
    <div class="page-title" style="flex-shrink: 0;">Event History</div>
    <div class="header-actions" style="display: flex; gap: 10px;">
        <button class="add-btn" onclick="exportHistory()" style="background: rgba(102,126,234,0.1); color: #667eea; border-color: rgba(102,126,234,0.3);"><i class="fas fa-download"></i> Export</button>
        <button class="add-btn" onclick="refreshHistory()"><i class="fas fa-sync-alt"></i> Refresh</button>
    </div>
</div>

<div class="filters-card">
    <div class="filters-header" onclick="toggleFilters()">
        <div class="filters-title"><i class="fas fa-filter"></i> Filters</div>
        <i class="fas fa-chevron-up filters-toggle"></i>
    </div>
    <div class="filters-body" id="filtersBody">
        <div class="filter-group">
            <label class="filter-label">Log Type</label>
            <select class="filter-select" id="filterType">
                <option value="">All Types</option>
                <option value="trade">Trade / Open</option>
                <option value="close">Close</option>
                <option value="copy">Copied</option>
                <option value="modify">Modify</option>
                <option value="signal">Signal</option>
                <option value="error">Error</option>
                <option value="warning">Warning</option>
                <option value="info">Info</option>
            </select>
        </div>
        <div class="filter-group">
            <label class="filter-label">Pair</label>
            <select class="filter-select" id="filterPair"><option value="">All Pairs</option></select>
        </div>
        <div class="filter-group">
            <label class="filter-label">Account</label>
            <select class="filter-select" id="filterAccount"><option value="">All Accounts</option></select>
        </div>
        <div class="filter-group">
            <label class="filter-label">Symbol</label>
            <input type="text" class="filter-input" id="filterSymbol" placeholder="e.g. EURUSD">
        </div>
        <div class="filter-group">
            <label class="filter-label">From</label>
            <input type="date" class="filter-input" id="filterDateFrom">
        </div>
        <div class="filter-group">
            <label class="filter-label">To</label>
            <input type="date" class="filter-input" id="filterDateTo">
        </div>
        <div class="filter-group">
            <label class="filter-label">Search</label>
            <input type="text" class="filter-input" id="filterSearch" placeholder="Search...">
        </div>
        <div class="filter-group">
            <label class="filter-label">Include Archives</label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" id="filterArchives" onchange="toggleArchives()" style="width: 16px; height: 16px; accent-color: #cc8800;">
                <span style="font-size: 11px; color: var(--text-secondary);">Load historical logs</span>
            </label>
        </div>
        <div class="filter-actions">
            <button class="btn-sm btn-primary" onclick="applyFilters()"><i class="fas fa-search"></i> Apply</button>
            <button class="btn-sm btn-secondary" onclick="clearFilters()"><i class="fas fa-times"></i> Clear</button>
        </div>
    </div>
</div>

<div class="stats-row">
    <div class="mini-stat"><div class="mini-stat-icon total"><i class="fas fa-list"></i></div><div class="mini-stat-content"><div class="value" id="statTotal">0</div><div class="label">Total Events</div></div></div>
    <div class="mini-stat"><div class="mini-stat-icon trades"><i class="fas fa-arrow-up"></i></div><div class="mini-stat-content"><div class="value" id="statTrades">0</div><div class="label">Trades</div></div></div>
    <div class="mini-stat"><div class="mini-stat-icon copied"><i class="fas fa-copy"></i></div><div class="mini-stat-content"><div class="value" id="statCopied">0</div><div class="label">Copied</div></div></div>
    <div class="mini-stat"><div class="mini-stat-icon errors"><i class="fas fa-exclamation-triangle"></i></div><div class="mini-stat-content"><div class="value" id="statErrors">0</div><div class="label">Errors</div></div></div>
    <div class="mini-stat"><div class="mini-stat-icon info"><i class="fas fa-info-circle"></i></div><div class="mini-stat-content"><div class="value" id="statInfo">0</div><div class="label">Info</div></div></div>
</div>
<div class="stats-row" style="margin-bottom: 20px;">
    <div class="mini-stat"><div class="mini-stat-icon" style="background: rgba(204,136,0,0.15); color: #cc8800;"><i class="fas fa-user-tie"></i></div><div class="mini-stat-content"><div class="value" id="statMaster">0</div><div class="label">Master Logs</div></div></div>
    <div class="mini-stat"><div class="mini-stat-icon" style="background: rgba(0,136,204,0.15); color: #0088cc;"><i class="fas fa-users"></i></div><div class="mini-stat-content"><div class="value" id="statChild">0</div><div class="label">Child Logs</div></div></div>
    <div class="mini-stat" style="grid-column: span 3;"><div class="mini-stat-icon" style="background: rgba(139,92,246,0.15); color: #8b5cf6;"><i class="fas fa-calendar-alt"></i></div><div class="mini-stat-content"><div class="value" id="statDateRange" style="font-size: 12px;">-</div><div class="label">Date Range</div></div></div>
</div>

<div class="history-table-card">
    <div class="table-header">
        <div class="table-title"><i class="fas fa-list"></i> Event Log <span class="table-count" id="tableCount">0</span></div>
        <div class="table-actions">
            <button class="table-action-btn" onclick="toggleAutoRefresh()"><i class="fas fa-sync-alt" id="autoRefreshIcon"></i> Auto</button>
        </div>
    </div>
    <div class="table-container">
        <table id="historyTable">
            <thead><tr><th>Time</th><th>Type</th><th>Account</th><th>Symbol</th><th>Message</th><th></th></tr></thead>
            <tbody id="historyBody"><tr><td colspan="6"><div class="empty-table"><i class="fas fa-inbox"></i><h3>Loading...</h3><p>Fetching history data</p></div></td></tr></tbody>
        </table>
    </div>
    <div class="pagination">
        <div class="pagination-info">Showing <span id="showingFrom">0</span>-<span id="showingTo">0</span> of <span id="totalRecords">0</span></div>
        <div class="pagination-btns" id="paginationBtns"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let allLogs = [], filteredLogs = [], currentPage = 1;
const perPage = 50;  // Increased from 30
let autoRefresh = false, refreshInterval = null;
let includeArchives = false;

async function fetchHistory() {
    try {
        const archiveParam = includeArchives ? '&archives=true' : '';
        const res = await fetch('/api/all-logs?limit=0' + archiveParam);  // 0 = unlimited
        const data = await res.json();
        allLogs = data.logs || [];
        updateFilterOptions();
        applyFilters();
        updateStats();
    } catch (e) {
        console.error('Error fetching history:', e);
        document.getElementById('historyBody').innerHTML = '<tr><td colspan="6"><div class="empty-table"><i class="fas fa-exclamation-triangle"></i><h3>Error loading data</h3><p>Check console for details</p></div></td></tr>';
    }
}

function normalizeType(log) {
    const t = (log.type || log.action || 'info').toLowerCase();
    const msg = (log.message || '').toLowerCase();
    if (t === 'trade' || t === 'open' || msg.includes('opened') || msg.includes('open trade') || msg.includes('buy ') || msg.includes('sell ')) return 'trade';
    if (t === 'close' || msg.includes('closed') || msg.includes('close trade')) return 'close';
    if (t === 'copy' || msg.includes('copied')) return 'copy';
    if (t === 'modify' || msg.includes('modified') || msg.includes('sl/tp')) return 'modify';
    if (t === 'signal' || msg.includes('signal')) return 'signal';
    if (t === 'error' || msg.includes('error') || msg.includes('failed')) return 'error';
    if (t === 'warning' || msg.includes('warning')) return 'warning';
    if (t === 'debug') return 'debug';
    return 'info';
}

function updateStats() {
    const total = filteredLogs.length;
    const trades = filteredLogs.filter(l => normalizeType(l) === 'trade').length;
    const copied = filteredLogs.filter(l => ['copy', 'signal', 'close'].includes(normalizeType(l)) || (l.message || '').toLowerCase().includes('copied')).length;
    const errors = filteredLogs.filter(l => ['error', 'warning'].includes(normalizeType(l))).length;
    const info = filteredLogs.filter(l => normalizeType(l) === 'info').length;
    
    // Source breakdown
    const masterLogs = filteredLogs.filter(l => l.account_type === 'MASTER').length;
    const childLogs = filteredLogs.filter(l => l.account_type === 'CHILD').length;
    
    // Date range
    let dateRange = '-';
    if (filteredLogs.length > 0) {
        const timestamps = filteredLogs.map(l => l.timestamp || '').filter(t => t).sort();
        if (timestamps.length > 0) {
            const oldest = timestamps[0].split(' ')[0];
            const newest = timestamps[timestamps.length - 1].split(' ')[0];
            if (oldest && newest) {
                dateRange = oldest === newest ? oldest : `${oldest} â†’ ${newest}`;
            }
        }
    }
    
    document.getElementById('statTotal').textContent = total.toLocaleString();
    document.getElementById('statTrades').textContent = trades.toLocaleString();
    document.getElementById('statCopied').textContent = copied.toLocaleString();
    document.getElementById('statErrors').textContent = errors.toLocaleString();
    document.getElementById('statInfo').textContent = info.toLocaleString();
    document.getElementById('statMaster').textContent = masterLogs.toLocaleString();
    document.getElementById('statChild').textContent = childLogs.toLocaleString();
    document.getElementById('statDateRange').textContent = dateRange;
}

function updateFilterOptions() {
    const pairSelect = document.getElementById('filterPair');
    const accountSelect = document.getElementById('filterAccount');
    const pairs = new Set(), accounts = new Set();
    allLogs.forEach(l => {
        if (l.pair_name) pairs.add(l.pair_name);
        if (l.account) accounts.add(l.account);
    });
    pairSelect.innerHTML = '<option value="">All Pairs</option>';
    accountSelect.innerHTML = '<option value="">All Accounts</option>';
    [...pairs].sort().forEach(p => pairSelect.innerHTML += '<option value="'+p+'">'+p+'</option>');
    [...accounts].sort().forEach(a => accountSelect.innerHTML += '<option value="'+a+'">'+a+'</option>');
}

function applyFilters() {
    const type = document.getElementById('filterType').value.toLowerCase();
    const pair = document.getElementById('filterPair').value;
    const account = document.getElementById('filterAccount').value;
    const symbol = document.getElementById('filterSymbol').value.toLowerCase();
    const dateFrom = document.getElementById('filterDateFrom').value;
    const dateTo = document.getElementById('filterDateTo').value;
    const search = document.getElementById('filterSearch').value.toLowerCase();
    
    filteredLogs = allLogs.filter(log => {
        const logType = normalizeType(log);
        if (type && logType !== type) return false;
        if (pair && log.pair_name !== pair) return false;
        if (account && log.account !== account) return false;
        if (symbol && !(log.symbol || '').toLowerCase().includes(symbol)) return false;
        if (dateFrom && (log.timestamp || '') < dateFrom) return false;
        if (dateTo && (log.timestamp || '') > dateTo + 'T23:59:59') return false;
        if (search && !(log.message || '').toLowerCase().includes(search)) return false;
        return true;
    });
    
    currentPage = 1;
    renderTable();
}

function clearFilters() {
    document.getElementById('filterType').value = '';
    document.getElementById('filterPair').value = '';
    document.getElementById('filterAccount').value = '';
    document.getElementById('filterSymbol').value = '';
    document.getElementById('filterDateFrom').value = '';
    document.getElementById('filterDateTo').value = '';
    document.getElementById('filterSearch').value = '';
    // Don't reset archives checkbox - user may want to keep viewing all
    applyFilters();
}

function renderTable() {
    const tbody = document.getElementById('historyBody');
    const start = (currentPage - 1) * perPage;
    const end = start + perPage;
    const pageData = filteredLogs.slice(start, end);
    
    document.getElementById('tableCount').textContent = filteredLogs.length;
    document.getElementById('showingFrom').textContent = filteredLogs.length ? start + 1 : 0;
    document.getElementById('showingTo').textContent = Math.min(end, filteredLogs.length);
    document.getElementById('totalRecords').textContent = filteredLogs.length;
    
    if (pageData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6"><div class="empty-table"><i class="fas fa-inbox"></i><h3>No records found</h3><p>Try adjusting your filters</p></div></td></tr>';
        document.getElementById('paginationBtns').innerHTML = '';
        return;
    }
    
    tbody.innerHTML = pageData.map((log, idx) => {
        const type = normalizeType(log);
        const accType = (log.account_type || 'system').toLowerCase();
        return '<tr class="expand-row" onclick="toggleRow(this)">' +
            '<td><span style="font-family:monospace;font-size:10px;color:#666;">'+(log.timestamp || '-')+'</span></td>' +
            '<td><span class="log-level '+type+'">'+type.toUpperCase()+'</span></td>' +
            '<td><span class="account-badge '+accType+'">'+accType.toUpperCase()+'</span> '+(log.account || '-')+'</td>' +
            '<td><span class="symbol-badge">'+(log.symbol ? '<i class="fas fa-chart-line"></i> '+log.symbol : '-')+'</span></td>' +
            '<td style="max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="'+((log.message||'').replace(/"/g,'&quot;'))+'">'+(log.message || '-')+'</td>' +
            '<td><i class="fas fa-chevron-right" style="color:#ccc;font-size:10px;"></i></td></tr>' +
            '<tr class="detail-row"><td colspan="6"><div class="detail-content"><div class="detail-grid">' +
            '<div class="detail-item"><span class="detail-label">Full Message</span><span class="detail-value">'+(log.message || '-')+'</span></div>' +
            '<div class="detail-item"><span class="detail-label">Pair</span><span class="detail-value">'+(log.pair_name || '-')+'</span></div>' +
            '<div class="detail-item"><span class="detail-label">Ticket</span><span class="detail-value">'+(log.ticket || '-')+'</span></div>' +
            '<div class="detail-item"><span class="detail-label">Volume</span><span class="detail-value">'+(log.volume || '-')+'</span></div>' +
            '<div class="detail-item"><span class="detail-label">Price</span><span class="detail-value">'+(log.price || '-')+'</span></div>' +
            '<div class="detail-item"><span class="detail-label">SL / TP</span><span class="detail-value">'+(log.sl || '-')+' / '+(log.tp || '-')+'</span></div>' +
            '</div></div></td></tr>';
    }).join('');
    
    renderPagination();
}

function toggleRow(row) {
    row.classList.toggle('expanded');
    const detailRow = row.nextElementSibling;
    if (detailRow && detailRow.classList.contains('detail-row')) detailRow.classList.toggle('show');
}

function renderPagination() {
    const totalPages = Math.ceil(filteredLogs.length / perPage);
    const container = document.getElementById('paginationBtns');
    if (totalPages <= 1) { container.innerHTML = ''; return; }
    
    let html = '<button class="page-btn" onclick="goToPage('+(currentPage-1)+')" '+(currentPage===1?'disabled':'')+'><i class="fas fa-chevron-left"></i></button>';
    const start = Math.max(1, currentPage - 2);
    const end = Math.min(totalPages, start + 4);
    for (let i = start; i <= end; i++) {
        html += '<button class="page-btn '+(i===currentPage?'active':'')+'" onclick="goToPage('+i+')">'+i+'</button>';
    }
    html += '<button class="page-btn" onclick="goToPage('+(currentPage+1)+')" '+(currentPage===totalPages?'disabled':'')+'><i class="fas fa-chevron-right"></i></button>';
    container.innerHTML = html;
}

function goToPage(page) {
    const totalPages = Math.ceil(filteredLogs.length / perPage);
    if (page < 1 || page > totalPages) return;
    currentPage = page;
    renderTable();
}

function toggleFilters() {
    document.querySelector('.filters-header').classList.toggle('collapsed');
    document.getElementById('filtersBody').classList.toggle('collapsed');
}

function toggleAutoRefresh() {
    autoRefresh = !autoRefresh;
    const icon = document.getElementById('autoRefreshIcon');
    if (autoRefresh) { icon.classList.add('fa-spin'); refreshInterval = setInterval(fetchHistory, 5000); }
    else { icon.classList.remove('fa-spin'); clearInterval(refreshInterval); }
}

function toggleArchives() {
    includeArchives = document.getElementById('filterArchives').checked;
    fetchHistory();
}

function refreshHistory() { fetchHistory(); if (typeof showToast === 'function') showToast('success', 'Refreshed', 'History updated'); }

function exportHistory() {
    if (filteredLogs.length === 0) { if (typeof showToast === 'function') showToast('warning', 'No data', 'No records to export'); return; }
    const csv = ['Timestamp,Type,Account,Symbol,Message,Ticket,Volume,Price'];
    filteredLogs.forEach(l => csv.push([l.timestamp||'', normalizeType(l), l.account||'', l.symbol||'', '"'+(l.message||'').replace(/"/g,'""')+'"', l.ticket||'', l.volume||'', l.price||''].join(',')));
    const blob = new Blob([csv.join('\n')], {type:'text/csv'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'history_' + new Date().toISOString().split('T')[0] + '.csv'; a.click();
}

fetchHistory();
</script>
{% endblock %}
