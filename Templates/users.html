{% extends "base.html" %}
{% block title %}User Management - MT5 Trade Copier{% endblock %}
{% block page_title %}<i class="fas fa-users-cog"></i> User Management{% endblock %}

{% block extra_css %}
<style>
    .users-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 25px; flex-wrap: wrap; gap: 15px; }
    .users-subtitle { font-size: 14px; color: var(--text-secondary); }
    
    .users-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
    .user-stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; display: flex; align-items: center; gap: 15px; transition: all var(--transition); }
    .user-stat-card:hover { transform: translateY(-2px); border-color: var(--border-hover); }
    .user-stat-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
    .user-stat-icon.total { background: rgba(59, 130, 246, 0.15); color: var(--accent); }
    .user-stat-icon.developers { background: rgba(139, 92, 246, 0.15); color: var(--purple); }
    .user-stat-icon.clients { background: rgba(16, 185, 129, 0.15); color: var(--success); }
    .user-stat-icon.active { background: rgba(6, 182, 212, 0.15); color: var(--cyan); }
    .user-stat-content .value { font-size: 28px; font-weight: 700; }
    .user-stat-content .label { font-size: 13px; color: var(--text-muted); }
    
    .users-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; overflow: hidden; }
    .users-card-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px; }
    .users-card-title { font-size: 18px; font-weight: 600; display: flex; align-items: center; gap: 10px; }
    .users-card-title i { color: var(--accent); }
    .search-box { display: flex; align-items: center; gap: 10px; padding: 10px 15px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 10px; min-width: 250px; }
    .search-box i { color: var(--text-muted); }
    .search-box input { flex: 1; background: none; border: none; color: var(--text-primary); font-size: 14px; outline: none; }
    .search-box input::placeholder { color: var(--text-muted); }
    
    .users-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 20px; padding: 20px; }
    .user-card { background: var(--bg-primary); border: 1px solid var(--border); border-radius: 14px; overflow: hidden; transition: all var(--transition); }
    .user-card:hover { border-color: var(--accent); transform: translateY(-3px); box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); }
    .user-card-header { padding: 20px; display: flex; align-items: flex-start; justify-content: space-between; border-bottom: 1px solid var(--border); }
    .user-info { display: flex; align-items: center; gap: 15px; }
    .user-avatar { width: 55px; height: 55px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 22px; font-weight: 600; }
    .user-avatar.developer { background: linear-gradient(135deg, var(--purple), #7c3aed); color: white; }
    .user-avatar.client { background: linear-gradient(135deg, var(--success), #059669); color: white; }
    .user-details h3 { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
    .user-meta { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .role-badge { padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    .role-badge.developer { background: rgba(139, 92, 246, 0.2); color: var(--purple); }
    .role-badge.client { background: rgba(16, 185, 129, 0.2); color: var(--success); }
    .status-indicator { display: flex; align-items: center; gap: 5px; font-size: 12px; color: var(--text-muted); }
    .status-indicator .dot { width: 8px; height: 8px; border-radius: 50%; }
    .status-indicator .dot.active { background: var(--success); }
    .status-indicator .dot.inactive { background: var(--text-muted); }
    .user-actions-dropdown { position: relative; }
    .dropdown-trigger { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: transparent; border: 1px solid var(--border); border-radius: 8px; color: var(--text-muted); cursor: pointer; transition: all var(--transition); }
    .dropdown-trigger:hover { background: var(--bg-hover); color: var(--text-primary); }
    .dropdown-menu { position: absolute; top: calc(100% + 5px); right: 0; min-width: 180px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); opacity: 0; visibility: hidden; transform: translateY(-5px); transition: all var(--transition); z-index: 100; }
    .dropdown-menu.show { opacity: 1; visibility: visible; transform: translateY(0); }
    .dropdown-item { display: flex; align-items: center; gap: 10px; padding: 12px 15px; font-size: 13px; color: var(--text-secondary); cursor: pointer; transition: all var(--transition); }
    .dropdown-item:hover { background: rgba(59, 130, 246, 0.1); color: var(--text-primary); }
    .dropdown-item.danger { color: var(--danger); }
    .dropdown-item.danger:hover { background: rgba(239, 68, 68, 0.1); }
    
    .user-card-body { padding: 20px; }
    .pairs-section { margin-bottom: 15px; }
    .pairs-label { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
    .pairs-label span { font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
    .pairs-count { padding: 2px 8px; background: var(--accent); color: white; border-radius: 10px; font-size: 11px; font-weight: 600; }
    .pairs-list { display: flex; flex-wrap: wrap; gap: 8px; }
    .pair-tag { display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; font-size: 12px; transition: all var(--transition); }
    .pair-tag i { font-size: 10px; color: var(--accent); }
    .pair-tag .remove { margin-left: 4px; color: var(--text-muted); cursor: pointer; transition: color var(--transition); }
    .pair-tag .remove:hover { color: var(--danger); }
    .no-pairs { font-size: 13px; color: var(--text-muted); font-style: italic; }
    
    .permissions-section { margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border); }
    .permissions-label { font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; }
    .permissions-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
    .permission-item { display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: var(--bg-card); border-radius: 6px; font-size: 12px; }
    .permission-item.enabled { color: var(--success); }
    .permission-item.disabled { color: var(--text-muted); }
    
    .user-card-footer { padding: 15px 20px; border-top: 1px solid var(--border); background: rgba(0, 0, 0, 0.2); display: flex; align-items: center; justify-content: space-between; }
    .last-login { font-size: 12px; color: var(--text-muted); display: flex; align-items: center; gap: 6px; }
    .quick-actions { display: flex; gap: 8px; }
    .quick-btn { padding: 8px 14px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 8px; color: var(--accent); font-size: 12px; cursor: pointer; transition: all var(--transition); display: flex; align-items: center; gap: 6px; }
    .quick-btn:hover { background: var(--accent); color: white; }
    .quick-btn.danger { background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.2); color: var(--danger); }
    .quick-btn.danger:hover { background: var(--danger); color: white; }
    
    .empty-users { padding: 60px 20px; text-align: center; }
    .empty-users i { font-size: 60px; color: var(--text-muted); opacity: 0.3; margin-bottom: 20px; }
    .empty-users h3 { font-size: 20px; margin-bottom: 10px; }
    .empty-users p { color: var(--text-secondary); margin-bottom: 20px; }
    
    .add-user-form { padding: 25px; }
    .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
    .form-group { display: flex; flex-direction: column; gap: 8px; }
    .form-group label { font-size: 13px; font-weight: 500; color: var(--text-secondary); }
    .form-group input, .form-group select { padding: 12px 15px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 10px; color: var(--text-primary); font-size: 14px; transition: all var(--transition); }
    .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }
    
    .pairs-selector { margin-top: 20px; padding: 20px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 12px; }
    .pairs-selector-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; }
    .pairs-selector-title { font-size: 14px; font-weight: 600; }
    .select-all-btn { font-size: 12px; color: var(--accent); cursor: pointer; }
    .pairs-checkbox-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; }
    .pair-checkbox { display: flex; align-items: center; gap: 10px; padding: 12px 15px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; transition: all var(--transition); }
    .pair-checkbox:hover { border-color: var(--accent); }
    .pair-checkbox.selected { background: rgba(59, 130, 246, 0.1); border-color: var(--accent); }
    .pair-checkbox input { display: none; }
    .pair-checkbox .checkmark { width: 20px; height: 20px; border: 2px solid var(--border); border-radius: 5px; display: flex; align-items: center; justify-content: center; color: transparent; transition: all var(--transition); }
    .pair-checkbox.selected .checkmark { background: var(--accent); border-color: var(--accent); color: white; }
    .pair-checkbox .pair-info { flex: 1; }
    .pair-checkbox .pair-name { font-size: 14px; font-weight: 500; }
    .pair-checkbox .pair-accounts { font-size: 11px; color: var(--text-muted); }
    
    .access-code-display { padding: 15px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 10px; margin-top: 15px; }
    .access-code-label { font-size: 12px; color: var(--text-muted); margin-bottom: 8px; }
    .access-code-value { display: flex; align-items: center; gap: 10px; }
    .access-code-value code { flex: 1; padding: 10px 15px; background: var(--bg-card); border-radius: 6px; font-family: 'JetBrains Mono', monospace; font-size: 14px; letter-spacing: 2px; }
    .access-code-value button { padding: 10px 15px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; color: var(--text-secondary); cursor: pointer; transition: all var(--transition); }
    .access-code-value button:hover { color: var(--accent); border-color: var(--accent); }
</style>
{% endblock %}

{% block content %}
<div class="users-header">
    <div>
        <div class="users-subtitle">Manage client access and permissions for your trading pairs</div>
    </div>
    <button class="btn btn-primary" onclick="openAddUserModal()"><i class="fas fa-plus"></i> Add User</button>
</div>

<div class="users-stats">
    <div class="user-stat-card">
        <div class="user-stat-icon total"><i class="fas fa-users"></i></div>
        <div class="user-stat-content"><div class="value" id="statTotal">0</div><div class="label">Total Users</div></div>
    </div>
    <div class="user-stat-card">
        <div class="user-stat-icon developers"><i class="fas fa-code"></i></div>
        <div class="user-stat-content"><div class="value" id="statDevelopers">0</div><div class="label">Developers</div></div>
    </div>
    <div class="user-stat-card">
        <div class="user-stat-icon clients"><i class="fas fa-user-tie"></i></div>
        <div class="user-stat-content"><div class="value" id="statClients">0</div><div class="label">Clients</div></div>
    </div>
    <div class="user-stat-card">
        <div class="user-stat-icon active"><i class="fas fa-user-check"></i></div>
        <div class="user-stat-content"><div class="value" id="statActive">0</div><div class="label">Active Today</div></div>
    </div>
</div>

<div class="users-card">
    <div class="users-card-header">
        <h3 class="users-card-title"><i class="fas fa-user-cog"></i> User Accounts</h3>
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="userSearch" placeholder="Search users..." oninput="filterUsers()">
        </div>
    </div>
    <div class="users-grid" id="usersGrid">
        <div class="empty-users" id="emptyUsers">
            <i class="fas fa-user-slash"></i>
            <h3>No users found</h3>
            <p>Add users to manage client access to trading pairs</p>
        </div>
    </div>
</div>

<div class="modal-backdrop" id="userModalBackdrop"></div>
<div class="modal" id="userModal" style="min-width: 600px;">
    <div class="modal-header">
        <h3 class="modal-title" id="userModalTitle">Add New User</h3>
        <button class="modal-close" onclick="closeUserModal()"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body">
        <form id="userForm">
            <input type="hidden" id="editUserId">
            <div class="form-row">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="formUsername" placeholder="Enter username" required>
                </div>
                <div class="form-group">
                    <label>Role</label>
                    <select id="formRole" onchange="togglePairsSelector()">
                        <option value="client">Client</option>
                        <option value="developer">Developer</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="formPassword" placeholder="Enter password">
                </div>
                <div class="form-group">
                    <label>Confirm Password</label>
                    <input type="password" id="formConfirmPassword" placeholder="Confirm password">
                </div>
            </div>
            <div id="pairsSelectorContainer">
                <div class="pairs-selector">
                    <div class="pairs-selector-header">
                        <span class="pairs-selector-title"><i class="fas fa-link"></i> Assign Trading Pairs</span>
                        <span class="select-all-btn" onclick="toggleAllPairs()">Select All</span>
                    </div>
                    <div class="pairs-checkbox-grid" id="pairsCheckboxGrid"></div>
                </div>
            </div>
            <div id="accessCodeSection" style="display: none;">
                <div class="access-code-display">
                    <div class="access-code-label">Client Access Code (share with client for login)</div>
                    <div class="access-code-value">
                        <code id="accessCodeDisplay">--------</code>
                        <button type="button" onclick="copyAccessCode()"><i class="fas fa-copy"></i></button>
                        <button type="button" onclick="regenerateAccessCode()"><i class="fas fa-sync-alt"></i></button>
                    </div>
                </div>
            </div>
        </form>
    </div>
    <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeUserModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveUser()"><i class="fas fa-save"></i> Save User</button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let users = [];
let pairs = [];
let editingUser = null;

async function fetchUsers() {
    try {
        const response = await fetch('/api/users');
        const data = await response.json();
        users = data.users || [];
        updateStats();
        renderUsers();
    } catch (error) {
        console.error('Error fetching users:', error);
        showToast('error', 'Error', 'Failed to fetch users');
    }
}

async function fetchPairs() {
    try {
        const response = await fetch('/api/pairs');
        const data = await response.json();
        pairs = data.pairs || [];
        renderPairsCheckboxes();
    } catch (error) {
        console.error('Error fetching pairs:', error);
    }
}

function updateStats() {
    document.getElementById('statTotal').textContent = users.length;
    document.getElementById('statDevelopers').textContent = users.filter(u => u.role === 'developer').length;
    document.getElementById('statClients').textContent = users.filter(u => u.role === 'client').length;
    document.getElementById('statActive').textContent = users.filter(u => u.last_login && isToday(u.last_login)).length;
}

function isToday(dateStr) {
    const today = new Date().toISOString().split('T')[0];
    return dateStr && dateStr.includes(today);
}

function renderUsers() {
    const grid = document.getElementById('usersGrid');
    const search = document.getElementById('userSearch').value.toLowerCase();
    const filtered = users.filter(u => u.username.toLowerCase().includes(search));
    
    if (filtered.length === 0) {
        grid.innerHTML = '<div class="empty-users"><i class="fas fa-user-slash"></i><h3>No users found</h3><p>Try a different search or add a new user</p></div>';
        return;
    }
    
    grid.innerHTML = filtered.map(user => {
        const assignedPairs = user.assigned_pairs || [];
        return `
            <div class="user-card" data-user="${user.username}">
                <div class="user-card-header">
                    <div class="user-info">
                        <div class="user-avatar ${user.role}">${user.username[0].toUpperCase()}</div>
                        <div class="user-details">
                            <h3>${user.username}</h3>
                            <div class="user-meta">
                                <span class="role-badge ${user.role}">${user.role}</span>
                                <span class="status-indicator"><span class="dot ${user.is_active !== false ? 'active' : 'inactive'}"></span> ${user.is_active !== false ? 'Active' : 'Inactive'}</span>
                            </div>
                        </div>
                    </div>
                    <div class="user-actions-dropdown">
                        <button class="dropdown-trigger" onclick="toggleDropdown(this)"><i class="fas fa-ellipsis-v"></i></button>
                        <div class="dropdown-menu">
                            <div class="dropdown-item" onclick="editUser('${user.username}')"><i class="fas fa-edit"></i> Edit User</div>
                            <div class="dropdown-item" onclick="resetPassword('${user.username}')"><i class="fas fa-key"></i> Reset Password</div>
                            <div class="dropdown-item danger" onclick="deleteUser('${user.username}')"><i class="fas fa-trash"></i> Delete User</div>
                        </div>
                    </div>
                </div>
                <div class="user-card-body">
                    ${user.role === 'client' ? `
                        <div class="pairs-section">
                            <div class="pairs-label"><span><i class="fas fa-link"></i> Assigned Pairs</span><span class="pairs-count">${assignedPairs.length}</span></div>
                            <div class="pairs-list">
                                ${assignedPairs.length > 0 ? assignedPairs.map(pairId => {
                                    const pair = pairs.find(p => p.id == pairId);
                                    return `<span class="pair-tag"><i class="fas fa-circle"></i> ${pair ? (pair.name || 'Pair ' + pair.id) : 'Pair ' + pairId}</span>`;
                                }).join('') : '<span class="no-pairs">No pairs assigned</span>'}
                            </div>
                        </div>
                    ` : `
                        <div class="permissions-section" style="border-top: none; padding-top: 0;">
                            <div class="permissions-label"><i class="fas fa-shield-alt"></i> Developer Access</div>
                            <div class="permissions-grid">
                                <div class="permission-item enabled"><i class="fas fa-check"></i> All Pairs</div>
                                <div class="permission-item enabled"><i class="fas fa-check"></i> User Management</div>
                                <div class="permission-item enabled"><i class="fas fa-check"></i> System Settings</div>
                                <div class="permission-item enabled"><i class="fas fa-check"></i> Full Logs</div>
                            </div>
                        </div>
                    `}
                </div>
                <div class="user-card-footer">
                    <span class="last-login"><i class="fas fa-clock"></i> ${user.last_login ? 'Last: ' + user.last_login : 'Never logged in'}</span>
                    <div class="quick-actions">
                        <button class="quick-btn" onclick="editUser('${user.username}')"><i class="fas fa-edit"></i> Edit</button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function renderPairsCheckboxes() {
    const container = document.getElementById('pairsCheckboxGrid');
    if (pairs.length === 0) {
        container.innerHTML = '<p style="color: var(--text-muted); font-size: 13px;">No trading pairs configured. Add pairs in Settings first.</p>';
        return;
    }
    
    container.innerHTML = pairs.map(pair => `
        <label class="pair-checkbox" data-pair="${pair.id}">
            <input type="checkbox" value="${pair.id}">
            <span class="checkmark"><i class="fas fa-check"></i></span>
            <div class="pair-info">
                <div class="pair-name">${pair.name || 'Pair ' + pair.id}</div>
                <div class="pair-accounts">${pair.children?.length || 0} child accounts</div>
            </div>
        </label>
    `).join('');
    
    document.querySelectorAll('.pair-checkbox').forEach(cb => {
        cb.addEventListener('click', function() {
            this.classList.toggle('selected');
            this.querySelector('input').checked = this.classList.contains('selected');
        });
    });
}

function toggleDropdown(btn) {
    document.querySelectorAll('.dropdown-menu.show').forEach(m => m.classList.remove('show'));
    btn.nextElementSibling.classList.toggle('show');
}

document.addEventListener('click', e => {
    if (!e.target.closest('.user-actions-dropdown')) {
        document.querySelectorAll('.dropdown-menu.show').forEach(m => m.classList.remove('show'));
    }
});

function openAddUserModal() {
    editingUser = null;
    document.getElementById('userModalTitle').textContent = 'Add New User';
    document.getElementById('editUserId').value = '';
    document.getElementById('formUsername').value = '';
    document.getElementById('formPassword').value = '';
    document.getElementById('formConfirmPassword').value = '';
    document.getElementById('formRole').value = 'client';
    document.querySelectorAll('.pair-checkbox').forEach(cb => {
        cb.classList.remove('selected');
        cb.querySelector('input').checked = false;
    });
    document.getElementById('accessCodeSection').style.display = 'none';
    togglePairsSelector();
    document.getElementById('userModalBackdrop').classList.add('show');
    document.getElementById('userModal').classList.add('show');
}

function editUser(username) {
    const user = users.find(u => u.username === username);
    if (!user) return;
    
    editingUser = user;
    document.getElementById('userModalTitle').textContent = 'Edit User: ' + username;
    document.getElementById('editUserId').value = username;
    document.getElementById('formUsername').value = user.username;
    document.getElementById('formPassword').value = '';
    document.getElementById('formConfirmPassword').value = '';
    document.getElementById('formRole').value = user.role;
    
    document.querySelectorAll('.pair-checkbox').forEach(cb => {
        const pairId = parseInt(cb.dataset.pair);
        const isAssigned = (user.assigned_pairs || []).includes(pairId);
        cb.classList.toggle('selected', isAssigned);
        cb.querySelector('input').checked = isAssigned;
    });
    
    if (user.access_code) {
        document.getElementById('accessCodeDisplay').textContent = user.access_code;
        document.getElementById('accessCodeSection').style.display = 'block';
    } else {
        document.getElementById('accessCodeSection').style.display = 'none';
    }
    
    togglePairsSelector();
    document.getElementById('userModalBackdrop').classList.add('show');
    document.getElementById('userModal').classList.add('show');
}

function closeUserModal() {
    document.getElementById('userModalBackdrop').classList.remove('show');
    document.getElementById('userModal').classList.remove('show');
    editingUser = null;
}

function togglePairsSelector() {
    const role = document.getElementById('formRole').value;
    document.getElementById('pairsSelectorContainer').style.display = role === 'client' ? 'block' : 'none';
}

function toggleAllPairs() {
    const checkboxes = document.querySelectorAll('.pair-checkbox');
    const allSelected = Array.from(checkboxes).every(cb => cb.classList.contains('selected'));
    checkboxes.forEach(cb => {
        cb.classList.toggle('selected', !allSelected);
        cb.querySelector('input').checked = !allSelected;
    });
}

async function saveUser() {
    const username = document.getElementById('formUsername').value.trim();
    const password = document.getElementById('formPassword').value;
    const confirmPassword = document.getElementById('formConfirmPassword').value;
    const role = document.getElementById('formRole').value;
    const editId = document.getElementById('editUserId').value;
    
    if (!username) { showToast('error', 'Error', 'Username is required'); return; }
    if (!editId && !password) { showToast('error', 'Error', 'Password is required for new users'); return; }
    if (password && password !== confirmPassword) { showToast('error', 'Error', 'Passwords do not match'); return; }
    
    const assignedPairs = [];
    if (role === 'client') {
        document.querySelectorAll('.pair-checkbox.selected').forEach(cb => {
            assignedPairs.push(parseInt(cb.dataset.pair));
        });
    }
    
    const userData = { username, role, assigned_pairs: assignedPairs };
    if (password) userData.password = password;
    
    try {
        const url = editId ? '/api/users/' + editId : '/api/users';
        const method = editId ? 'PUT' : 'POST';
        const response = await fetch(url, {
            method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(userData)
        });
        const data = await response.json();
        
        if (data.success) {
            showToast('success', 'Success', editId ? 'User updated successfully' : 'User created successfully');
            closeUserModal();
            fetchUsers();
        } else {
            showToast('error', 'Error', data.error || 'Failed to save user');
        }
    } catch (error) {
        showToast('error', 'Error', 'Failed to save user');
    }
}

async function deleteUser(username) {
    if (!confirm('Are you sure you want to delete user "' + username + '"?')) return;
    
    try {
        const response = await fetch('/api/users/' + username, { method: 'DELETE' });
        const data = await response.json();
        if (data.success) {
            showToast('success', 'Deleted', 'User deleted successfully');
            fetchUsers();
        } else {
            showToast('error', 'Error', data.error || 'Failed to delete user');
        }
    } catch (error) {
        showToast('error', 'Error', 'Failed to delete user');
    }
}

async function resetPassword(username) {
    const newPassword = prompt('Enter new password for ' + username + ':');
    if (!newPassword) return;
    
    try {
        const response = await fetch('/api/users/' + username + '/reset-password', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ password: newPassword })
        });
        const data = await response.json();
        if (data.success) {
            showToast('success', 'Success', 'Password reset successfully');
        } else {
            showToast('error', 'Error', data.error || 'Failed to reset password');
        }
    } catch (error) {
        showToast('error', 'Error', 'Failed to reset password');
    }
}

function copyAccessCode() {
    const code = document.getElementById('accessCodeDisplay').textContent;
    navigator.clipboard.writeText(code);
    showToast('success', 'Copied', 'Access code copied to clipboard');
}

function filterUsers() { renderUsers(); }

fetchUsers();
fetchPairs();
</script>
{% endblock %}