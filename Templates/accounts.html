{% extends "base.html" %}
{% block title %}Account Management - MT5 Trade Copier{% endblock %}
{% block page_title %}<i class="fas fa-users-cog"></i> Account Management{% endblock %}

{% block extra_css %}
<style>
        .page-header { display: flex !important; align-items: center !important; margin-bottom: 32px !important; gap: 24px !important; }
    .page-title { font-size: 12px !important; font-weight: 600 !important; color: var(--text-muted) !important; text-transform: none !important; letter-spacing: 0 !important; flex-shrink: 0 !important; }
    .add-btn { padding: 10px 18px !important; background: var(--bg-card) !important; color: var(--text-secondary) !important; border: 1px solid var(--border) !important; border-radius: 999px !important; font-size: 13px !important; font-weight: 600 !important; cursor: pointer !important; display: flex !important; align-items: center !important; gap: 8px !important; transition: all 0.2s !important; width: fit-content !important; margin-left: auto !important; }
    .add-btn:hover { border-color: var(--border-hover); color: var(--text-primary); background: var(--bg-hover); }

    /* Utility classes */
    .text-success { color: #00cc66 !important; }
    .text-muted { color: #555 !important; }

    .pairs-grid { display: flex; flex-direction: column; gap: 12px; }

    @keyframes glow-border {
        0%, 100% { box-shadow: 0 0 5px rgba(255,255,255,0.03); }
        50% { box-shadow: 0 0 15px rgba(255,255,255,0.08); }
    }
    @keyframes glow-gold {
        0%, 100% { box-shadow: 0 0 8px rgba(204,136,0,0.15); border-color: rgba(204,136,0,0.25); }
        50% { box-shadow: 0 0 18px rgba(204,136,0,0.3); border-color: rgba(204,136,0,0.45); }
    }
    @keyframes glow-blue {
        0%, 100% { box-shadow: 0 0 8px rgba(0,136,204,0.15); border-color: rgba(0,136,204,0.25); }
        50% { box-shadow: 0 0 18px rgba(0,136,204,0.3); border-color: rgba(0,136,204,0.45); }
    }
    
    /* Collapsible Pair Card */
    .pair-card { background: #0d0d0d; border: 1px solid #1a1a1a; border-radius: 12px; overflow: hidden; transition: all 0.3s; animation: glow-border 4s ease-in-out infinite; }
    .pair-card:hover { border-color: #333; }
    .pair-card.expanded { border-color: #444; box-shadow: 0 0 25px rgba(255,255,255,0.08); }
    
    .pair-head { padding: 14px 18px; display: flex; justify-content: space-between; align-items: center; background: #0a0a0a; cursor: pointer; transition: background 0.2s; }
    .pair-head:hover { background: #111; }
    .pair-title { display: flex; align-items: center; gap: 14px; flex: 1; }
    .pair-num { width: 36px; height: 36px; border-radius: 8px; background: linear-gradient(135deg, #1a1a1a, #222); border: 1px solid #333; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700; color: #888; }
    .pair-info { flex: 1; }
    .pair-name { font-size: 15px; font-weight: 600; color: #ccc; margin-bottom: 2px; }
    .pair-meta { font-size: 10px; color: #555; display: flex; gap: 15px; }
    .pair-meta span { display: flex; align-items: center; gap: 4px; }
    .pair-meta i { font-size: 8px; }
    .pair-toggle { width: 32px; height: 32px; border-radius: 6px; background: #1a1a1a; border: 1px solid #333; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #666; transition: all 0.3s; margin-right: 10px; }
    .pair-card.expanded .pair-toggle { transform: rotate(180deg); color: #0088cc; background: #081014; border-color: #0088cc40; }
    .pair-actions-btns { display: flex; gap: 8px; }
    .pair-act-btn { width: 34px; height: 34px; border-radius: 6px; border: 1px solid #333; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; transition: all 0.2s; background: #1a1a1a; }
    .pair-act-btn.edit { color: #00aaff; }
    .pair-act-btn.edit:hover { background: #00aaff; color: #fff; border-color: #00aaff; box-shadow: 0 0 12px rgba(0,170,255,0.4); }
    .pair-act-btn.delete { color: #ff4466; }
    .pair-act-btn.delete:hover { background: #ff4466; color: #fff; border-color: #ff4466; box-shadow: 0 0 12px rgba(255,68,102,0.4); }

    /* Collapsible Body */
    .pair-body { max-height: 0; overflow: hidden; transition: max-height 0.35s ease-out, padding 0.35s ease-out; padding: 0 18px; }
    .pair-card.expanded .pair-body { max-height: 1500px; padding: 16px 18px; }
    
    .acct-section { margin-bottom: 16px; }
    .acct-section:last-child { margin-bottom: 0; }
    .section-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid #1a1a1a; }
    .section-lbl { font-size: 9px; font-weight: 600; text-transform: uppercase; letter-spacing: 1.5px; display: flex; align-items: center; gap: 6px; }
    .section-lbl.master { color: #cc8800; }
    .section-lbl.child { color: #0088cc; }
    .section-lbl::before { content: ''; width: 3px; height: 10px; border-radius: 1px; }
    .section-lbl.master::before { background: #cc8800; box-shadow: 0 0 8px rgba(204,136,0,0.5); }
    .section-lbl.child::before { background: #0088cc; box-shadow: 0 0 8px rgba(0,136,204,0.5); }
    .child-count { font-size: 11px; color: #0088cc; font-weight: 600; padding: 4px 10px; background: #081014; border: 1px solid #0088cc40; border-radius: 12px; }
    .add-child-btn { padding: 6px 14px; border-radius: 5px; background: #1a1a1a; color: #0088cc; border: 1px solid #0088cc40; font-size: 10px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 5px; transition: all 0.2s; }
    .add-child-btn:hover { background: #0088cc; color: #fff; box-shadow: 0 0 12px rgba(0,136,204,0.4); }

    .acct-card { padding: 14px; border-radius: 10px; margin-bottom: 10px; position: relative; transition: all 0.2s; }
    .acct-card.master { background: #0f0d08; border: 1px solid #332800; animation: glow-gold 4s ease-in-out infinite; }
    .acct-card.master:hover { border-color: #cc8800; box-shadow: 0 0 15px rgba(204,136,0,0.15); }
    .acct-card.child { background: #080d0f; border: 1px solid #002833; animation: glow-blue 4s ease-in-out infinite; }
    .acct-card.child:hover { border-color: #0088cc; box-shadow: 0 0 15px rgba(0,136,204,0.15); }
    .acct-top { display: flex; justify-content: space-between; align-items: flex-start; }
    .acct-info { flex: 1; }
    .acct-login { font-size: 16px; font-weight: 700; font-family: 'JetBrains Mono', monospace; margin-bottom: 3px; color: #ddd; }
    .acct-server { font-size: 10px; color: var(--text-secondary) !important; }
    
    /* ALWAYS VISIBLE BUTTONS - Not hidden on hover */
    .acct-btns { display: flex; gap: 6px; }
    .acct-btn { width: 28px; height: 28px; border-radius: 5px; border: 1px solid #333; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 10px; transition: all 0.2s; background: #1a1a1a; }
    .acct-btn.edit { color: #00aaff; }
    .acct-btn.edit:hover { background: #00aaff; color: #fff; border-color: #00aaff; box-shadow: 0 0 10px rgba(0,170,255,0.4); }
    .acct-btn.delete { color: #ff4466; }
    .acct-btn.delete:hover { background: #ff4466; color: #fff; border-color: #ff4466; box-shadow: 0 0 10px rgba(255,68,102,0.4); }
    
    .acct-meta { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-top: 12px; padding-top: 12px; border-top: 1px solid #1a1a1a; }
    .meta-item { font-size: 9px; }
    .meta-item span { color: #555; display: block; margin-bottom: 2px; text-transform: uppercase; letter-spacing: 0.5px; }
    .meta-item strong { color: #999; font-family: 'JetBrains Mono', monospace; }
    
    /* Children Grid for better layout */
    .children-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 10px; }
    .no-children { padding: 20px; text-align: center; color: #444; font-size: 11px; background: #080808; border: 1px dashed #222; border-radius: 8px; }

    .empty-state { grid-column: 1 / -1; text-align: center; padding: 60px 20px; background: #0a0a0a; border: 1px dashed #222; border-radius: 12px; }
    .empty-state i { font-size: 40px; color: #222; margin-bottom: 12px; }
    .empty-state h3 { font-size: 16px; margin-bottom: 6px; color: #666; }
    .empty-state p { font-size: 11px; color: #444; margin-bottom: 20px; }

    /* Modal */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(8px); z-index: 10000; display: none; align-items: center; justify-content: center; padding: 20px; }
    .modal-overlay.active { display: flex; }
    .modal-box { background: #0d0d0d; border: 1px solid #222; border-radius: 16px; width: 100%; max-width: 720px; max-height: 85vh; overflow-y: auto; animation: modalIn 0.25s ease; }
    @keyframes modalIn { from { opacity: 0; transform: scale(0.96) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
    .modal-head { padding: 20px 24px; border-bottom: 1px solid #1a1a1a; display: flex; justify-content: space-between; align-items: center; background: #0a0a0a; }
    .modal-title { font-size: 16px; font-weight: 700; display: flex; align-items: center; gap: 10px; color: #ccc; }
    .modal-title i { width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 14px; }
    .modal-title i.master-icon { background: #1a1408; border: 1px solid #332800; color: #cc8800; }
    .modal-title i.child-icon { background: #081014; border: 1px solid #002833; color: #0088cc; }
    .modal-close { width: 32px; height: 32px; border-radius: 6px; background: #1a1a1a; border: 1px solid #333; color: #666; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
    .modal-close:hover { background: #ff4466; border-color: #ff4466; color: #fff; }
    .modal-body { padding: 28px; }
    .modal-foot { padding: 16px 24px; border-top: 1px solid #1a1a1a; display: flex; justify-content: flex-end; gap: 10px; background: #0a0a0a; }
    .modal-btn { padding: 12px 24px; border-radius: 8px; font-size: 11px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s; border: 1px solid; }
    .modal-btn.cancel { background: #1a1a1a; color: #888; border-color: #333; }
    .modal-btn.cancel:hover { background: #2a2a2a; color: #ccc; }
    .modal-btn.save { background: #0088cc; color: #fff; border-color: #0088cc; }
    .modal-btn.save:hover { background: #00aaff; box-shadow: 0 0 15px rgba(0,170,255,0.4); }

    /* Form */
    .form-section { margin-bottom: 20px; padding: 16px; background: #0b0b0b; border: 1px solid #151515; border-radius: 12px; }
    .form-section-title { font-size: 9px; font-weight: 600; text-transform: uppercase; letter-spacing: 1.5px; color: #555; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
    .form-section-title::before { content: ''; width: 3px; height: 12px; border-radius: 1px; }
    .form-section-title.cred::before { background: #00cc6a; box-shadow: 0 0 6px rgba(0,204,106,0.5); }
    .form-section-title.settings::before { background: #0088cc; box-shadow: 0 0 6px rgba(0,136,204,0.5); }
    .form-section-title.time::before { background: #cc8800; box-shadow: 0 0 6px rgba(204,136,0,0.5); }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    .form-grid.triple { grid-template-columns: 1fr 1fr 1fr; }
    .form-grid.copy-grid { grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); }
    .form-group { display: flex; flex-direction: column; gap: 6px; }
    .form-group.full { grid-column: 1 / -1; }
    .form-label { font-size: 10px; font-weight: 600; color: #666; display: flex; align-items: center; gap: 5px; }
    .form-label i { font-size: 9px; color: #444; }
    .form-input { padding: 12px 14px; background: #0a0a0a; border: 1px solid #222; border-radius: 8px; color: #ccc; font-size: 12px; transition: all 0.2s; }
    .form-input:focus { outline: none; border-color: #0088cc; box-shadow: 0 0 10px rgba(0,136,204,0.2); }
    .form-input::placeholder { color: #444; }
    .form-input[type="number"] { font-family: 'JetBrains Mono', monospace; }
    .form-select { padding: 12px 14px; background: #0a0a0a; border: 1px solid #222; border-radius: 8px; color: #ccc; font-size: 12px; cursor: pointer; }
    .form-select:focus { outline: none; border-color: #0088cc; }
    .form-select option { background: #0d0d0d; color: #ccc; }
    .form-hint { font-size: 9px; color: #444; margin-top: 2px; }

    .toast-msg { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(80px); padding: 14px 24px; border-radius: 10px; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 10px; z-index: 9999; transition: transform 0.35s ease; border: 1px solid; }
    .toast-msg.show { transform: translateX(-50%) translateY(0); }
    .toast-msg.success { background: #0a1a0a; border-color: #00cc6a; color: #00cc6a; box-shadow: 0 0 20px rgba(0,204,106,0.3); }
    .toast-msg.error { background: #1a0a0a; border-color: #ff4466; color: #ff4466; box-shadow: 0 0 20px rgba(255,68,102,0.3); }
    html[data-theme="light"] .page-title { font-size: 12px !important; font-weight: 600 !important; color: var(--text-muted) !important; text-transform: none !important; letter-spacing: 0 !important; flex-shrink: 0 !important; } html[data-theme="light"] .acct-server { color: #555 !important; } html[data-theme="light"] .acct-login { color: #1a1a1a !important; } html[data-theme="light"] .add-btn { padding: 10px 18px !important; background: var(--bg-card) !important; color: var(--text-secondary) !important; border: 1px solid var(--border) !important; border-radius: 999px !important; font-size: 13px !important; font-weight: 600 !important; cursor: pointer !important; display: flex !important; align-items: center !important; gap: 8px !important; transition: all 0.2s !important; width: fit-content !important; margin-left: auto !important; }

/* Calendar icon visibility fix for both themes */
.form-input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(0.5); cursor: pointer; opacity: 0.8; padding: 2px; }
.form-input[type="date"]::-webkit-calendar-picker-indicator:hover { opacity: 1; }
html[data-theme="light"] .form-input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(0.2); opacity: 1; }
</style>
{% endblock %}

{% block content %}
<div class="page-header" style="display: flex; justify-content: space-between; align-items: center; gap: 24px; margin-bottom: 32px; width: 100%;">
    <div class="page-title" style="flex-shrink: 0;">Trading Pairs</div>
    <button class="add-btn" onclick="openPairModal()"><i class="fas fa-plus"></i> Add Pair</button>
</div>

<div class="pairs-grid" id="pairsGrid">
    <div class="empty-state"><i class="fas fa-inbox"></i><h3>No Trading Pairs</h3><p>Create your first pair to start copying trades</p><button class="add-btn" onclick="openPairModal()"><i class="fas fa-plus"></i> Create Pair</button></div>
</div>

<!-- Add/Edit Pair Modal -->
<div class="modal-overlay" id="pairModal">
    <div class="modal-box">
        <div class="modal-head">
            <div class="modal-title"><i class="fas fa-crown master-icon"></i><span id="pairModalTitle">Create Pair</span></div>
            <button class="modal-close" onclick="closePairModal()"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <form id="pairForm">
                <input type="hidden" name="id" id="pairEditId">
                <div class="form-section">
                    <div class="form-section-title cred">Master Account</div>
                    <div class="form-grid">
                        <div class="form-group"><label class="form-label"><i class="fas fa-user"></i> Account Number</label><input type="text" class="form-input" name="master_account" id="pairMasterAccount" placeholder="e.g. 123456" required></div>
                        <div class="form-group"><label class="form-label"><i class="fas fa-key"></i> Password</label><input type="password" class="form-input" name="master_password" id="pairMasterPassword" placeholder="Account password" required></div>
                    </div>
                    <div class="form-grid" style="margin-top:14px">
                        <div class="form-group"><label class="form-label"><i class="fas fa-server"></i> Server</label><input type="text" class="form-input" name="master_server" id="pairMasterServer" placeholder="e.g. ICMarkets-Demo" required></div>
                        <div class="form-group"><label class="form-label"><i class="fas fa-folder"></i> Terminal Path</label><input type="text" class="form-input" name="master_terminal" id="pairMasterTerminal" placeholder="C:\MT5\terminal64.exe"></div>
                    </div>
                </div>
                <div class="form-section">
                    <div class="form-section-title settings" style="display:flex;justify-content:space-between;align-items:center;"><span>Master Symbol Mapping</span><button type="button" class="modal-btn" onclick="addMasterSymbolSlot()" style="padding:6px 12px;font-size:12px;"><i class="fas fa-plus"></i> Add Slot</button></div><div class="form-grid copy-grid" id="masterSymbolContainer">
                        <div class="form-group"><label class="form-label"><i class="fas fa-sync"></i> Master Symbol 1</label><input type="text" class="form-input" name="master_symbol_1" id="pairMasterSymbol1" placeholder="e.g. EURUSD"><span class="form-hint">Maps to child symbol 1</span></div>
                        </div>
                </div>
                <div class="form-section">
                    <div class="form-section-title settings">Pair Settings</div>
                    <div class="form-group"><label class="form-label"><i class="fas fa-tag"></i> Pair Name</label><input type="text" class="form-input" name="name" id="pairName" placeholder="e.g. Main Strategy"></div>
                </div>
            </form>
        </div>
        <div class="modal-foot">
            <button class="modal-btn cancel" onclick="closePairModal()">Cancel</button>
            <button class="modal-btn save" id="pairSaveBtn" onclick="savePair()"><i class="fas fa-check"></i> Create</button>
        </div>
    </div>
</div>

<!-- Add/Edit Child Modal -->
<div class="modal-overlay" id="childModal">
    <div class="modal-box">
        <div class="modal-head">
            <div class="modal-title"><i class="fas fa-user-plus child-icon"></i><span id="childModalTitle">Add Child Account</span></div>
            <button class="modal-close" onclick="closeChildModal()"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <form id="childForm">
                <input type="hidden" name="pair_id" id="childPairId">
                <input type="hidden" name="child_id" id="childEditId">
                <div class="form-section">
                    <div class="form-section-title cred">Account Credentials</div>
                    <div class="form-grid">
                        <div class="form-group"><label class="form-label"><i class="fas fa-user"></i> Account Number</label><input type="text" class="form-input" name="account" id="childAccount" placeholder="e.g. 654321" required></div>
                        <div class="form-group"><label class="form-label"><i class="fas fa-key"></i> Password</label><input type="password" class="form-input" name="password" id="childPassword" placeholder="Account password" required></div>
                    </div>
                    <div class="form-grid" style="margin-top:14px">
                        <div class="form-group"><label class="form-label"><i class="fas fa-server"></i> Server</label><input type="text" class="form-input" name="server" id="childServer" placeholder="e.g. ICMarkets-Demo" required></div>
                        <div class="form-group"><label class="form-label"><i class="fas fa-folder"></i> Terminal Path</label><input type="text" class="form-input" name="terminal" id="childTerminal" placeholder="C:\MT5\terminal64.exe"></div>
                    </div>
                </div>
                <div class="form-section">
                    <div class="form-section-title settings">Copy Settings</div>
                    <div class="form-grid copy-grid">
                        <div class="form-group"><label class="form-label"><i class="fas fa-percentage"></i> Lot Multiplier</label><input type="number" class="form-input" name="lot_multiplier" id="childLotMultiplier" value="1.0" step="0.01" min="0.01"><span class="form-hint">Multiply master lot</span></div>
                        <div class="form-group"><label class="form-label"><i class="fas fa-copy"></i> Copy Mode</label><select class="form-select" name="copy_mode" id="childCopyMode"><option value="normal">Normal</option><option value="reverse">Reverse</option><option value="only_buy">Only Buy</option><option value="only_sell">Only Sell</option></select></div>
                        <div class="form-group"><label class="form-label"><i class="fas fa-toggle-on"></i> Copy Close</label><select class="form-select" name="copy_close" id="childCopyClose"><option value="true">Yes</option><option value="false">No</option></select></div>
                        
                        <div class="form-group"><label class="form-label"><i class="fas fa-bolt"></i> Force Copy</label><select class="form-select" name="force_copy" id="childForceCopy"><option value="false">Disabled</option><option value="true">Enabled</option></select><span class="form-hint">Force on errors</span></div>
                        <div class="form-group"><label class="form-label"><i class="fas fa-shield-alt"></i> Copy SL</label><select class="form-select" name="copy_sl" id="childCopySL"><option value="true">Yes</option><option value="false">No</option></select><span class="form-hint">Copy Stop Loss</span></div>
                        <div class="form-group"><label class="form-label"><i class="fas fa-bullseye"></i> Copy TP</label><select class="form-select" name="copy_tp" id="childCopyTP"><option value="true">Yes</option><option value="false">No</option></select><span class="form-hint">Copy Take Profit</span></div>
                        <div class="form-group"><label class="form-label"><i class="fas fa-clock"></i> Copy Pending</label><select class="form-select" name="copy_pending" id="childCopyPending"><option value="false">No</option><option value="true">Yes</option></select><span class="form-hint">Copy pending orders</span></div>
                    </div>
                </div>
                <div class="form-section">
                    <div class="form-section-title settings" style="display:flex;justify-content:space-between;align-items:center;"><span>Child Symbol Mapping</span><button type="button" class="modal-btn" onclick="addChildSymbolSlot()" style="padding:6px 12px;font-size:12px;"><i class="fas fa-plus"></i> Add Slot</button></div><div class="form-grid copy-grid" id="childSymbolContainer">
                        <div class="form-group"><label class="form-label"><i class="fas fa-link"></i> Child Symbol 1</label><input type="text" class="form-input" name="child_symbol_1" id="childSymbol1" placeholder="e.g. EURUSD.b"><span class="form-hint">For master symbol 1</span></div>
                        
                        
                        
                        
                    </div>
                </div>
                <div class="form-section">
                    <div class="form-section-title time">Copy Period Settings</div>
                    <div class="form-group" style="margin-bottom: 14px;">
                        <label class="form-label"><i class="fas fa-toggle-on"></i> Enable Copy Period</label>
                        <select class="form-select" name="copy_period_enabled" id="childCopyPeriodEnabled" onchange="toggleCopyPeriod()">
                            <option value="false">Disabled (Always Copy)</option>
                            <option value="true">Enabled (Copy within dates only)</option>
                        </select>
                        <span class="form-hint">When enabled, trades will only be copied within the specified date range</span>
                    </div>
                    <div id="copyPeriodDates" class="form-grid" style="display: none;">
                        <div class="form-group"><label class="form-label"><i class="fas fa-calendar"></i> Active From</label><input type="date" class="form-input" name="active_from" id="childActiveFrom"><span class="form-hint">Start copying from this date</span></div>
                        <div class="form-group"><label class="form-label"><i class="fas fa-calendar-check"></i> Active Until</label><input type="date" class="form-input" name="active_to" id="childActiveTo"><span class="form-hint">Stop copying after this date</span></div>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-foot">
            <button class="modal-btn cancel" onclick="closeChildModal()">Cancel</button>
            <button class="modal-btn save" id="childSaveBtn" onclick="saveChild()"><i class="fas fa-plus"></i> Add Child</button>
        </div>
    </div>
</div>

<div class="toast-msg" id="toastMsg"></div>
{% endblock %}

{% block extra_js %}
<script>
let pairs = [];
let editingPair = null;
let editingChild = null;

async function loadPairs(preserveExpanded = false) {
    // Save expanded pair IDs before reloading
    let expandedIds = [];
    if (preserveExpanded) {
        expandedIds = [...document.querySelectorAll('.pair-card.expanded')].map(c => c.id);
    }
    try {
        const res = await fetch('/api/pairs');
        pairs = await res.json();
        if (!Array.isArray(pairs)) pairs = pairs.pairs || [];
        renderPairs();
        // Restore expanded state
        if (preserveExpanded && expandedIds.length > 0) {
            expandedIds.forEach(id => {
                const card = document.getElementById(id);
                if (card) card.classList.add('expanded');
            });
        }
    } catch(e) { console.error(e); }
}

function renderPairs() {
    const grid = document.getElementById('pairsGrid');
    if (!pairs.length) {
        grid.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><h3>No Trading Pairs</h3><p>Create your first pair to start copying trades</p><button class="add-btn" onclick="openPairModal()"><i class="fas fa-plus"></i> Create Pair</button></div>';
        return;
    }
    grid.innerHTML = pairs.map((p, i) => {
        const children = p.children || [];
        return '<div class="pair-card" id="pair-' + p.id + '">' +
            '<div class="pair-head" onclick="togglePair(\'' + p.id + '\', event)">' +
                '<div class="pair-title">' +
                    '<div class="pair-toggle"><i class="fas fa-chevron-down"></i></div>' +
                    '<div class="pair-num">' + (i+1) + '</div>' +
                    '<div class="pair-info">' +
                        '<div class="pair-name">' + (p.name || 'Pair ' + (i+1)) + '</div>' +
                        '<div class="pair-meta">' +
                            '<span><i class="fas fa-crown"></i> ' + (p.master_account || 'N/A') + '</span>' +
                            '<span><i class="fas fa-users"></i> ' + children.length + ' Children</span>' +
                            '<span><i class="fas fa-circle ' + (p.status?.master_running ? 'text-success' : 'text-muted') + '"></i> ' + (p.status?.master_running ? 'Running' : 'Stopped') + '</span>' +
                        '</div>' +
                    '</div>' +
                '</div>' +
                '<div class="pair-actions-btns">' +
                    '<button class="pair-act-btn edit" onclick="openEditPairModal(\'' + p.id + '\'); event.stopPropagation();"><i class="fas fa-edit"></i></button>' +
                    '<button class="pair-act-btn delete" onclick="deletePair(\'' + p.id + '\'); event.stopPropagation();"><i class="fas fa-trash"></i></button>' +
                '</div>' +
            '</div>' +
            '<div class="pair-body">' +
                '<div class="acct-section"><div class="section-head"><div class="section-lbl master">Master Account</div></div>' +
                    '<div class="acct-card master"><div class="acct-top"><div class="acct-info"><div class="acct-login">' + (p.master_account || 'N/A') + '</div><div class="acct-server">' + (p.master_server || 'Unknown') + '</div></div><div class="acct-btns"><button class="acct-btn edit" onclick="openEditPairModal(\'' + p.id + '\')" title="Edit Master"><i class="fas fa-edit"></i></button></div></div>' +
                        '<div class="acct-meta"><div class="meta-item"><span>Terminal</span><strong>' + (p.master_terminal ? 'Set' : 'Default') + '</strong></div><div class="meta-item"><span>Status</span><strong>' + (p.status?.master_running ? 'Running' : 'Stopped') + '</strong></div><div class="meta-item"><span>Children</span><strong>' + children.length + '</strong></div></div>' +
                    '</div>' +
                '</div>' +
                '<div class="acct-section">' +
                    '<div class="section-head"><div class="section-lbl child">Child Accounts</div><span class="child-count">' + children.length + ' Accounts</span><button class="add-child-btn" onclick="openChildModal(\'' + p.id + '\')"><i class="fas fa-plus"></i> Add</button></div>' +
                    '<div class="children-grid">' +
                    (children.length ? children.map(c => '<div class="acct-card child"><div class="acct-top"><div class="acct-info"><div class="acct-login">' + (c.account || 'N/A') + '</div><div class="acct-server">' + (c.server || 'Unknown') + '</div></div><div class="acct-btns"><button class="acct-btn edit" onclick="openEditChildModal(\'' + p.id + '\',\'' + c.id + '\')" title="Edit"><i class="fas fa-edit"></i></button><button class="acct-btn delete" onclick="deleteChild(\'' + p.id + '\',\'' + c.id + '\')"><i class="fas fa-times"></i></button></div></div>' +
                        '<div class="acct-meta"><div class="meta-item"><span>Lot Multi</span><strong>' + (c.lot_multiplier || '1.0') + 'x</strong></div><div class="meta-item"><span>Mode</span><strong>' + (c.copy_mode || 'Normal') + '</strong></div><div class="meta-item"><span>Copy Close</span><strong>' + (c.copy_close !== false ? 'Yes' : 'No') + '</strong></div><div class="meta-item"><span>Symbol</span><strong>' + (c.symbol_override || 'Master') + '</strong></div></div>' +
                    '</div>').join('') : '<div class="no-children"><i class="fas fa-user-plus"></i> No child accounts yet - click Add to create one</div>') +
                    '</div>' +
                '</div>' +
            '</div>' +
        '</div>';
    }).join('');
}

function togglePair(pairId, event) {
    // Don't toggle if clicking on buttons
    if (event.target.closest('.pair-actions-btns')) return;
    const card = document.getElementById('pair-' + pairId);
    if (card) {
        card.classList.toggle('expanded');
    }
}

function openPairModal() { 
    editingPair = null;
    document.getElementById('pairModalTitle').textContent = 'Create Pair';
    document.getElementById('pairSaveBtn').innerHTML = '<i class="fas fa-check"></i> Create';
    document.getElementById('pairForm').reset();
    document.getElementById('pairEditId').value = '';
    // Reset symbol container to just slot 1
    const container = document.getElementById('masterSymbolContainer');
    container.innerHTML = '<div class="form-group"><label class="form-label"><i class="fas fa-sync"></i> Master Symbol 1</label><input type="text" class="form-input" name="master_symbol_1" id="pairMasterSymbol1" placeholder="e.g. EURUSD"><span class="form-hint">Maps to child symbol 1</span></div>';
    document.getElementById('pairModal').classList.add('active'); 
}

function openEditPairModal(pairId) {
    const pair = pairs.find(p => p.id === pairId);
    if (!pair) return;
    editingPair = pair;
    document.getElementById('pairModalTitle').textContent = 'Edit Master Account';
    document.getElementById('pairSaveBtn').innerHTML = '<i class="fas fa-save"></i> Save Changes';
    document.getElementById('pairEditId').value = pair.id;
    document.getElementById('pairMasterAccount').value = pair.master_account || '';
    document.getElementById('pairMasterPassword').value = pair.master_password || '';
    document.getElementById('pairMasterServer').value = pair.master_server || '';
    document.getElementById('pairMasterTerminal').value = pair.master_terminal || '';
    document.getElementById('pairName').value = pair.name || '';
    
    // Dynamically create and populate master symbol slots
    const container = document.getElementById('masterSymbolContainer');
    container.innerHTML = '<div class="form-group"><label class="form-label"><i class="fas fa-sync"></i> Master Symbol 1</label><input type="text" class="form-input" name="master_symbol_1" id="pairMasterSymbol1" placeholder="e.g. EURUSD"><span class="form-hint">Maps to child symbol 1</span></div>';
    document.getElementById('pairMasterSymbol1').value = pair['master_symbol_1'] || '';
    
    // Add slots for any additional symbols that exist
    for(let i=2; i<=20; i++) {
        const symbolValue = pair['master_symbol_' + i];
        if (symbolValue) {
            const newDiv = document.createElement('div');
            newDiv.className = 'form-group';
            newDiv.innerHTML = '<label class="form-label"><i class="fas fa-sync"></i> Master Symbol ' + i + '</label><input type="text" class="form-input" name="master_symbol_' + i + '" id="pairMasterSymbol' + i + '" placeholder="e.g. EURUSD"><span class="form-hint">Maps to child symbol ' + i + '</span><button type="button" class="modal-btn" onclick="this.parentElement.remove()" style="padding: 4px 8px; font-size: 11px; margin-top: 4px; background-color: #f44336;"><i class="fas fa-trash"></i> Remove</button>';
            container.appendChild(newDiv);
            document.getElementById('pairMasterSymbol' + i).value = symbolValue;
        }
    }
    
    document.getElementById('pairModal').classList.add('active');
}

function closePairModal() { 
    document.getElementById('pairModal').classList.remove('active'); 
    document.getElementById('pairForm').reset();
    // Reset symbol container to just slot 1
    const container = document.getElementById('masterSymbolContainer');
    container.innerHTML = '<div class="form-group"><label class="form-label"><i class="fas fa-sync"></i> Master Symbol 1</label><input type="text" class="form-input" name="master_symbol_1" id="pairMasterSymbol1" placeholder="e.g. EURUSD"><span class="form-hint">Maps to child symbol 1</span></div>';
    editingPair = null;
}

function openChildModal(pairId) { 
    editingChild = null;
    document.getElementById('childModalTitle').textContent = 'Add Child Account';
    document.getElementById('childSaveBtn').innerHTML = '<i class="fas fa-plus"></i> Add Child';
    document.getElementById('childPairId').value = pairId; 
    document.getElementById('childEditId').value = '';
    document.getElementById('childForm').reset();
    document.getElementById('childLotMultiplier').value = '1.0';
    document.getElementById('childCopyMode').value = 'normal';
    document.getElementById('childCopyClose').value = 'true';
    document.getElementById('childForceCopy').value = 'false';
    document.getElementById('childCopySL').value = 'true';
    document.getElementById('childCopyTP').value = 'true';
    document.getElementById('childCopyPending').value = 'true';
    document.getElementById('childCopyPeriodEnabled').value = 'false';
    document.getElementById('copyPeriodDates').style.display = 'none';
    // Reset symbol container to just slot 1
    const container = document.getElementById('childSymbolContainer');
    container.innerHTML = '<div class="form-group"><label class="form-label"><i class="fas fa-link"></i> Child Symbol 1</label><input type="text" class="form-input" name="child_symbol_1" id="childSymbol1" placeholder="e.g. EURUSD.b"><span class="form-hint">For master symbol 1</span></div>';
    document.getElementById('childModal').classList.add('active'); 
}

function openEditChildModal(pairId, childId) {
    const pair = pairs.find(p => p.id === pairId);
    if (!pair) return;
    const child = (pair.children || []).find(c => c.id === childId);
    if (!child) return;
    editingChild = child;
    document.getElementById('childModalTitle').textContent = 'Edit Child Account';
    document.getElementById('childSaveBtn').innerHTML = '<i class="fas fa-save"></i> Save Changes';
    document.getElementById('childPairId').value = pairId;
    document.getElementById('childEditId').value = childId;
    document.getElementById('childAccount').value = child.account || '';
    document.getElementById('childPassword').value = child.password || '';
    document.getElementById('childServer').value = child.server || '';
    document.getElementById('childTerminal').value = child.terminal || '';
    document.getElementById('childLotMultiplier').value = child.lot_multiplier || 1.0;
    document.getElementById('childCopyMode').value = child.copy_mode || 'normal';
    document.getElementById('childCopyClose').value = child.copy_close !== false ? 'true' : 'false';
    document.getElementById('childForceCopy').value = child.force_copy === true ? 'true' : 'false';
    document.getElementById('childCopySL').value = child.copy_sl !== false ? 'true' : 'false';
    document.getElementById('childCopyTP').value = child.copy_tp !== false ? 'true' : 'false';
    document.getElementById('childCopyPending').value = child.copy_pending !== false ? 'true' : 'false';
    
    // Dynamically create and populate child symbol slots
    const container = document.getElementById('childSymbolContainer');
    // Reset to just first slot
    container.innerHTML = '<div class="form-group"><label class="form-label"><i class="fas fa-link"></i> Child Symbol 1</label><input type="text" class="form-input" name="child_symbol_1" id="childSymbol1" placeholder="e.g. EURUSD.b"><span class="form-hint">For master symbol 1</span></div>';
    document.getElementById('childSymbol1').value = child['child_symbol_1'] || '';
    
    // Add slots for any additional symbols that exist
    for(let i=2; i<=20; i++) {
        const symbolValue = child['child_symbol_' + i];
        if (symbolValue) {
            const newDiv = document.createElement('div');
            newDiv.className = 'form-group';
            newDiv.innerHTML = '<label class="form-label"><i class="fas fa-link"></i> Child Symbol ' + i + '</label><input type="text" class="form-input" name="child_symbol_' + i + '" id="childSymbol' + i + '" placeholder="e.g. EURUSD.b"><span class="form-hint">For master symbol ' + i + '</span><button type="button" class="modal-btn" onclick="this.parentElement.remove()" style="padding: 4px 8px; font-size: 11px; margin-top: 4px; background-color: #f44336;"><i class="fas fa-trash"></i> Remove</button>';
            container.appendChild(newDiv);
            document.getElementById('childSymbol' + i).value = symbolValue;
        }
    }
    
    // Set copy period enabled state
    const hasPeriod = child.active_from || child.active_to || child.copy_period_enabled;
    document.getElementById('childCopyPeriodEnabled').value = hasPeriod ? 'true' : 'false';
    document.getElementById('copyPeriodDates').style.display = hasPeriod ? 'grid' : 'none';
    document.getElementById('childActiveFrom').value = child.active_from || '';
    document.getElementById('childActiveTo').value = child.active_to || '';
    document.getElementById('childModal').classList.add('active');
}

function closeChildModal() { 
    document.getElementById('childModal').classList.remove('active'); 
    document.getElementById('childForm').reset();
    // Reset symbol container to just slot 1
    const container = document.getElementById('childSymbolContainer');
    container.innerHTML = '<div class="form-group"><label class="form-label"><i class="fas fa-link"></i> Child Symbol 1</label><input type="text" class="form-input" name="child_symbol_1" id="childSymbol1" placeholder="e.g. EURUSD.b"><span class="form-hint">For master symbol 1</span></div>';
    editingChild = null;
}

function toggleCopyPeriod() {
    const enabled = document.getElementById('childCopyPeriodEnabled').value === 'true';
    const datesDiv = document.getElementById('copyPeriodDates');
    if (enabled) {
        datesDiv.style.display = 'grid';
    } else {
        datesDiv.style.display = 'none';
        document.getElementById('childActiveFrom').value = '';
        document.getElementById('childActiveTo').value = '';
    }
}

function addMasterSymbolSlot() {
    const container = document.getElementById('masterSymbolContainer');
    const inputs = container.querySelectorAll('input[name^="master_symbol_"]');
    const maxSlot = Math.max(0, ...Array.from(inputs).map(inp => {
        const match = inp.name.match(/master_symbol_(\d+)/);
        return match ? parseInt(match[1]) : 0;
    }));
    const newSlot = maxSlot + 1;
    const newDiv = document.createElement('div');
    newDiv.className = 'form-group';
    newDiv.innerHTML = `
        <label class="form-label"><i class="fas fa-sync"></i> Master Symbol ${newSlot}</label>
        <input type="text" class="form-input" name="master_symbol_${newSlot}" id="pairMasterSymbol${newSlot}" placeholder="e.g. EURUSD">
        <span class="form-hint">Maps to child symbol ${newSlot}</span>
        <button type="button" class="modal-btn" onclick="this.parentElement.remove()" style="padding: 4px 8px; font-size: 11px; margin-top: 4px; background-color: #f44336;"><i class="fas fa-trash"></i> Remove</button>
    `;
    container.appendChild(newDiv);
}

function addChildSymbolSlot() {
    const container = document.getElementById('childSymbolContainer');
    const inputs = container.querySelectorAll('input[name^="child_symbol_"]');
    const maxSlot = Math.max(0, ...Array.from(inputs).map(inp => {
        const match = inp.name.match(/child_symbol_(\d+)/);
        return match ? parseInt(match[1]) : 0;
    }));
    const newSlot = maxSlot + 1;
    const newDiv = document.createElement('div');
    newDiv.className = 'form-group';
    newDiv.innerHTML = `
        <label class="form-label"><i class="fas fa-link"></i> Child Symbol ${newSlot}</label>
        <input type="text" class="form-input" name="child_symbol_${newSlot}" id="childSymbol${newSlot}" placeholder="e.g. EURUSD.b">
        <span class="form-hint">For master symbol ${newSlot}</span>
        <button type="button" class="modal-btn" onclick="this.parentElement.remove()" style="padding: 4px 8px; font-size: 11px; margin-top: 4px; background-color: #f44336;"><i class="fas fa-trash"></i> Remove</button>
    `;
    container.appendChild(newDiv);
}
async function savePair() {
    const form = document.getElementById('pairForm');
    const formData = new FormData(form);
    const data = {};
    formData.forEach((v, k) => { if (k !== 'id') data[k] = v; });
    
    if (data.master_account) data.master_account = parseInt(data.master_account) || 0;
    
    // FIX: Renumber master symbols to be consecutive (1,2,3...) to avoid gaps
    const masterSymbols = [];
    for (let i = 1; i <= 20; i++) {
        const key = 'master_symbol_' + i;
        if (data[key] && data[key].trim()) {
            masterSymbols.push(data[key].trim().toUpperCase());
        }
        delete data[key]; // Remove old key
    }
    // Re-add with consecutive numbering
    masterSymbols.forEach((sym, idx) => {
        data['master_symbol_' + (idx + 1)] = sym;
    });
    
    const pairId = document.getElementById('pairEditId').value;
    const isEdit = pairId && pairId.length > 0;
    
    try {
        const url = isEdit ? '/api/pairs/' + pairId : '/api/pairs';
        const method = isEdit ? 'PUT' : 'POST';
        const res = await fetch(url, { 
            method: method, 
            headers: {'Content-Type': 'application/json'}, 
            body: JSON.stringify(data) 
        });
        const result = await res.json();
        if (result.success) {
            closePairModal(); loadPairs(true);
            toast('success', isEdit ? 'Pair updated!' : 'Pair created!');
        } else {
            toast('error', result.error || 'Failed');
        }
    } catch(e) { toast('error', 'Failed to save'); }
}

async function saveChild() {
    const form = document.getElementById('childForm');
    const formData = new FormData(form);
    const data = {};
    formData.forEach((v, k) => { if (k !== 'pair_id' && k !== 'child_id') data[k] = v; });
    
    const pairId = document.getElementById('childPairId').value;
    const childId = document.getElementById('childEditId').value;
    const isEdit = childId && childId.length > 0;
    
    if (data.account) data.account = parseInt(data.account) || 0;
    if (data.lot_multiplier) data.lot_multiplier = parseFloat(data.lot_multiplier) || 1.0;
    if (data.copy_close) data.copy_close = data.copy_close === 'true';
    if (data.force_copy) data.force_copy = data.force_copy === 'true';
    if (data.copy_sl) data.copy_sl = data.copy_sl === 'true';
    if (data.copy_tp) data.copy_tp = data.copy_tp === 'true';
    if (data.copy_pending) data.copy_pending = data.copy_pending === 'true';
    if (data.copy_period_enabled) data.copy_period_enabled = data.copy_period_enabled === 'true';
    // Clear dates if period is disabled
    if (!data.copy_period_enabled) {
        data.active_from = '';
        data.active_to = '';
    }
    if (data.symbol_override !== undefined) {
        data.symbol_override = data.symbol_override.trim();
        if (!data.symbol_override) { delete data.symbol_override; }
    }
    
    // FIX: Renumber child symbols to be consecutive (1,2,3...) to avoid gaps
    const childSymbols = [];
    for (let i = 1; i <= 20; i++) {
        const key = 'child_symbol_' + i;
        if (data[key] && data[key].trim()) {
            childSymbols.push(data[key].trim().toUpperCase());
        }
        delete data[key]; // Remove old key
    }
    // Re-add with consecutive numbering
    childSymbols.forEach((sym, idx) => {
        data['child_symbol_' + (idx + 1)] = sym;
    });

    
    try {
        const url = isEdit ? '/api/pairs/' + pairId + '/children/' + childId : '/api/pairs/' + pairId + '/children';
        const method = isEdit ? 'PUT' : 'POST';
        const res = await fetch(url, { 
            method: method, 
            headers: {'Content-Type': 'application/json'}, 
            body: JSON.stringify(data) 
        });
        const result = await res.json();
        if (result.success) {
            closeChildModal(); loadPairs(true);
            toast('success', isEdit ? 'Child updated!' : 'Child added!');
        } else {
            toast('error', result.error || 'Failed');
        }
    } catch(e) { toast('error', 'Failed to save child'); }
}

async function deletePair(id) {
    if (!confirm('Delete this pair and all children?')) return;
    try {
        await fetch('/api/pairs/' + id, { method: 'DELETE' }); loadPairs(true);
        toast('success', 'Pair deleted');
    } catch(e) { toast('error', 'Failed'); }
}

async function deleteChild(pairId, childId) {
    if (!confirm('Remove this child?')) return;
    try {
        await fetch('/api/pairs/' + pairId + '/children/' + childId, { method: 'DELETE' }); loadPairs(true);
        toast('success', 'Child removed');
    } catch(e) { toast('error', 'Failed'); }
}

function toast(type, msg) {
    const t = document.getElementById('toastMsg');
    t.className = 'toast-msg ' + type + ' show';
    t.innerHTML = '<i class="fas fa-' + (type === 'success' ? 'check' : 'times') + '"></i> ' + msg;
    setTimeout(() => t.classList.remove('show'), 2500);
}

loadPairs();
</script>
{% endblock %}



























