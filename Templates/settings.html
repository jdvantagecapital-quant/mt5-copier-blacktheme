{% extends "base.html" %}
{% block title %}Settings - Trade Copier{% endblock %}
{% block page_title %}<i class="fas fa-cog"></i> Settings{% endblock %}

{% block extra_css %}
<style>
.settings-page { max-width: 1200px; margin: 0 auto; }
.settings-tabs { display:flex; gap:10px; margin:0 0 16px 0; }
.settings-page .tab { display:flex; align-items:center; gap:8px; padding:8px 14px; border:1px solid var(--border); border-radius:999px; background: var(--bg-card); color: var(--text-secondary); font-size:12px; font-weight:600; cursor:pointer; transition: all var(--transition); }
.settings-page .tab:hover { border-color: var(--border-hover); color: var(--text-primary); }
.settings-page .tab.active { background: var(--success); border-color: var(--success); color: var(--bg-primary); }
.settings-page .tab i { font-size:12px; opacity:.9; }
.settings-page .panel { background: linear-gradient(145deg, #0f0f0f 0%, #0a0a0a 100%); border:1px solid var(--border); border-radius:12px; overflow:hidden; box-shadow: 0 4px 20px rgba(0,0,0,.3); }
.settings-page .panel-header { display:flex; align-items:center; justify-content:space-between; padding:20px 24px; border-bottom:1px solid var(--border); background: linear-gradient(135deg, rgba(255,255,255,0.03) 0%, transparent 100%); }
.settings-page .panel-title { display:flex; align-items:center; gap:12px; font-size:16px; font-weight:700; letter-spacing:2px; text-transform:uppercase; }
.settings-page .panel-sub { font-size:11px; color: var(--text-muted); letter-spacing:.5px; }
.settings-page .header-status { display:flex; align-items:center; gap:10px; }
.settings-page .status-pill { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:.8px; border-radius:999px; background: var(--success-dim); color: var(--success); border:1px solid rgba(0,255,136,.25); }
.settings-page .status-dot { width:8px; height:8px; background: var(--success); border-radius:50%; box-shadow:0 0 8px var(--success-glow); }
.settings-page .panel-body { padding:24px; }
.settings-page .group { margin-bottom:24px; }
.settings-page .group:last-child { margin-bottom:0; }
.settings-page .group-title { display:flex; align-items:center; gap:8px; font-size:10px; font-weight:700; letter-spacing:2px; text-transform:uppercase; color: var(--text-secondary); margin-bottom:12px; }
.settings-page .group-title i { font-size:11px; opacity:.7; }
.settings-page .row { display:flex; align-items:center; justify-content:space-between; gap:16px; padding:14px 16px; border:1px solid var(--border); background: rgba(255,255,255,.02); border-radius:10px; margin-bottom:10px; transition: all var(--transition); }
.settings-page .row:hover { background: rgba(255,255,255,.04); border-color: var(--border-hover); }
.settings-page .row-left { display:flex; align-items:center; gap:12px; min-width:0; }
.settings-page .icon-badge { width:34px; height:34px; display:flex; align-items:center; justify-content:center; border-radius:10px; background: var(--bg-elevated); border:1px solid var(--border); color: var(--text-secondary); }
.settings-page .label { font-size:13px; font-weight:600; color: var(--text-primary); }
.settings-page .desc { font-size:11px; color: var(--text-muted); }
.settings-page .field-grid { display:flex; gap:16px; }
.settings-page .field { flex:1; min-width:0; }
.settings-page .field .form-label { margin-bottom:6px; }
.settings-page .toggle-switch { position:relative; width:52px; height:28px; border-radius:16px; background: rgba(255,255,255,.08); border:2px solid rgba(255,255,255,.18); box-shadow: inset 0 2px 4px rgba(0,0,0,.3); cursor:pointer; transition: all .25s ease; }
.settings-page .toggle-switch::after { content:''; position:absolute; top:3px; left:3px; width:18px; height:18px; border-radius:50%; background: linear-gradient(145deg,#fff,#ddd); box-shadow: 0 2px 6px rgba(0,0,0,.35); transition: all .25s ease; }
.settings-page .toggle-switch.is-on { background: linear-gradient(135deg,#00ff88,#00c864); border-color:#00ff88; box-shadow: 0 0 18px rgba(0,255,136,.35); }
.settings-page .toggle-switch.is-on::after { left:27px; }
.settings-page .panel-footer { display:flex; align-items:center; justify-content:space-between; gap:12px; padding:16px 24px; border-top:1px solid var(--border); background: rgba(0,0,0,.18); }
.settings-page .hint { display:flex; align-items:center; gap:8px; color: var(--text-muted); font-size:11px; }
@media (max-width: 768px) { .settings-page .field-grid { flex-direction:column; } }
</style>
{% endblock %}

{% block content %}
<div class="settings-page">
  <div class="settings-tabs" id="settingsTabs">
    <div class="tab active" data-panel="general"><i class="fas fa-sliders-h"></i><span>General</span></div>
    <div class="tab" data-panel="copy"><i class="fas fa-copy"></i><span>Trade Copy</span></div>
    <div class="tab" data-panel="about"><i class="fas fa-info-circle"></i><span>About</span></div>
  </div>

  <section class="panel" id="panel-general">
    <div class="panel-header">
      <div><div class="panel-title"><i class="fas fa-cog"></i><span>General Settings</span></div><div class="panel-sub">Application behavior and server configuration</div></div>
      <div class="header-status"><span class="status-pill"><span class="status-dot"></span>Active</span></div>
    </div>
    <div class="panel-body">
      <div class="group">
        <div class="group-title"><i class="fas fa-desktop"></i><span>Application</span></div>
        <div class="row"><div class="row-left"><div class="icon-badge"><i class="fas fa-power-off"></i></div><div><div class="label">Auto-start on boot</div><div class="desc">Launch when Windows starts</div></div></div><div class="row-right"><div class="toggle-switch" id="autoStart" data-setting="auto_start"></div></div></div>
        <div class="row"><div class="row-left"><div class="icon-badge"><i class="fas fa-window-minimize"></i></div><div><div class="label">Start minimized</div><div class="desc">Start in system tray</div></div></div><div class="row-right"><div class="toggle-switch" id="startMinimized" data-setting="start_minimized"></div></div></div>
      </div>
      <div class="group">
        <div class="group-title"><i class="fas fa-server"></i><span>Server</span></div>
        <div class="field-grid">
          <div class="field"><label class="form-label">Port</label><div class="input-wrapper"><i class="fas fa-network-wired input-icon"></i><input type="number" class="form-control" id="serverPort" value="5000"></div></div>
          <div class="field"><label class="form-label">Log Level</label><div class="input-wrapper"><i class="fas fa-list-alt input-icon"></i><select class="form-control" id="logLevel"><option value="INFO">Info</option><option value="DEBUG">Debug</option><option value="ERROR">Error</option></select></div></div>
        </div>
      </div>
      <div class="group">
        <div class="group-title"><i class="fas fa-clock"></i><span>Refresh Settings</span></div>
        <div class="field-grid">
          <div class="field"><label class="form-label">Copy Interval (ms)</label><div class="input-wrapper"><i class="fas fa-sync input-icon"></i><input type="number" class="form-control" id="copyInterval" value="100" min="50" max="5000"></div></div>
          <div class="field"><label class="form-label">Retry Attempts</label><div class="input-wrapper"><i class="fas fa-redo input-icon"></i><input type="number" class="form-control" id="retryAttempts" value="3" min="1" max="10"></div></div>
        </div>
      </div>
    </div>
    <div class="panel-footer">
      <div class="hint"><i class="fas fa-info-circle"></i>Changes will be applied after saving</div>
      <div><button class="btn btn-secondary btn-sm" onclick="resetSettings()"><i class="fas fa-undo"></i> Reset</button><button class="btn btn-success btn-sm" onclick="saveSettings()"><i class="fas fa-save"></i> Save</button></div>
    </div>
  </section>

  <section class="panel" id="panel-copy" style="display:none;">
    <div class="panel-header">
      <div><div class="panel-title"><i class="fas fa-copy"></i><span>Trade Copy Settings</span></div><div class="panel-sub">Copying behavior and execution options</div></div>
      <div class="header-status"><span class="status-pill"><span class="status-dot"></span>Active</span></div>
    </div>
    <div class="panel-body">
      <div class="group">
        <div class="group-title"><i class="fas fa-bolt"></i><span>Execution</span></div>
        <div class="field-grid">
          <div class="field"><label class="form-label">Slippage (pts)</label><div class="input-wrapper"><i class="fas fa-exchange-alt input-icon"></i><input type="number" class="form-control" id="defSlippage" value="10"></div><div class="form-hint"><i class="fas fa-info-circle"></i>Maximum slippage points</div></div>
          <div class="field"><label class="form-label">Delay (ms)</label><div class="input-wrapper"><i class="fas fa-clock input-icon"></i><input type="number" class="form-control" id="defDelay" value="0"></div><div class="form-hint"><i class="fas fa-info-circle"></i>Execution delay</div></div>
        </div>
      </div>
      <div class="group">
        <div class="group-title"><i class="fas fa-toggle-on"></i><span>Options</span></div>
        <div class="row"><div class="row-left"><div class="icon-badge"><i class="fas fa-arrow-down"></i></div><div><div class="label">Copy Stop Loss</div><div class="desc">Copy SL to child</div></div></div><div class="row-right"><div class="toggle-switch is-on" id="copySL" data-setting="copy_sl"></div></div></div>
        <div class="row"><div class="row-left"><div class="icon-badge"><i class="fas fa-arrow-up"></i></div><div><div class="label">Copy Take Profit</div><div class="desc">Copy TP to child</div></div></div><div class="row-right"><div class="toggle-switch is-on" id="copyTP" data-setting="copy_tp"></div></div></div>
        <div class="row"><div class="row-left"><div class="icon-badge"><i class="fas fa-hourglass-half"></i></div><div><div class="label">Copy Pending</div><div class="desc">Copy pending orders</div></div></div><div class="row-right"><div class="toggle-switch" id="copyPending" data-setting="copy_pending"></div></div></div>
      </div>
    </div>
    <div class="panel-footer">
      <div class="hint"><i class="fas fa-info-circle"></i>Changes will be applied after saving</div>
      <div><button class="btn btn-success btn-sm" onclick="saveSettings()"><i class="fas fa-save"></i> Save</button></div>
    </div>
  </section>

  <section class="panel" id="panel-about" style="display:none;">
    <div class="panel-body" style="padding:60px 24px; text-align:center;">
      <div style="width:84px;height:84px;margin:0 auto 18px;background:linear-gradient(135deg,#ffffff,#cccccc);border-radius:16px;display:flex;align-items:center;justify-content:center;color:#000;box-shadow:0 8px 24px rgba(0,0,0,.4);"><i class="fas fa-bolt" style="font-size:32px"></i></div>
      <div style="font-size:20px;font-weight:800;letter-spacing:2px;">MT5 Trade Copier</div>
      <div class="text-muted" style="margin:6px 0 14px; font-size:11px; text-transform:uppercase; letter-spacing:2px;">Version 2.0.0 | Pro</div>
      <div class="text-secondary" style="max-width:460px;margin:0 auto; font-size:12px;">Professional MetaTrader 5 trade copying with real-time sync and advanced features.</div>
    </div>
  </section>
</div>
{% endblock %}

{% block extra_js %}
<script>
const tabs = document.querySelectorAll('#settingsTabs .tab');
const panels = { general: document.getElementById('panel-general'), copy: document.getElementById('panel-copy'), about: document.getElementById('panel-about') };

tabs.forEach(t => t.addEventListener('click', () => {
  tabs.forEach(tb => tb.classList.remove('active'));
  t.classList.add('active');
  Object.values(panels).forEach(p => p.style.display = 'none');
  document.getElementById('panel-' + t.dataset.panel).style.display = 'block';
}));

Array.from(document.querySelectorAll('.settings-page .toggle-switch')).forEach(el => {
  el.addEventListener('click', () => el.classList.toggle('is-on'));
});

async function loadSettings() {
  try {
    const res = await fetch('/api/settings');
    const data = await res.json();
    if (data.success && data.settings) {
      const s = data.settings;
      document.getElementById('serverPort').value = s.server_port || 5000;
      document.getElementById('logLevel').value = s.log_level || 'INFO';
      document.getElementById('copyInterval').value = s.copy_interval || 100;
      document.getElementById('retryAttempts').value = s.retry_attempts || 3;
      document.getElementById('defSlippage').value = s.slippage || 10;
      document.getElementById('defDelay').value = s.delay || 0;
      if (s.auto_start) document.getElementById('autoStart').classList.add('is-on'); else document.getElementById('autoStart').classList.remove('is-on');
      if (s.start_minimized) document.getElementById('startMinimized').classList.add('is-on'); else document.getElementById('startMinimized').classList.remove('is-on');
      if (s.copy_sl !== false) document.getElementById('copySL').classList.add('is-on'); else document.getElementById('copySL').classList.remove('is-on');
      if (s.copy_tp !== false) document.getElementById('copyTP').classList.add('is-on'); else document.getElementById('copyTP').classList.remove('is-on');
      if (s.copy_pending) document.getElementById('copyPending').classList.add('is-on'); else document.getElementById('copyPending').classList.remove('is-on');
    }
  } catch(e) { console.error('Failed to load settings:', e); }
}

async function saveSettings() {
  const settings = {
    server_port: parseInt(document.getElementById('serverPort').value) || 5000,
    log_level: document.getElementById('logLevel').value,
    copy_interval: parseInt(document.getElementById('copyInterval').value) || 100,
    retry_attempts: parseInt(document.getElementById('retryAttempts').value) || 3,
    slippage: parseInt(document.getElementById('defSlippage').value) || 10,
    delay: parseInt(document.getElementById('defDelay').value) || 0,
    auto_start: document.getElementById('autoStart').classList.contains('is-on'),
    start_minimized: document.getElementById('startMinimized').classList.contains('is-on'),
    copy_sl: document.getElementById('copySL').classList.contains('is-on'),
    copy_tp: document.getElementById('copyTP').classList.contains('is-on'),
    copy_pending: document.getElementById('copyPending').classList.contains('is-on')
  };
  try {
    const res = await fetch('/api/settings', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(settings) });
    const data = await res.json();
    if (data.success) { showToast('success', 'Saved', 'Settings saved successfully'); }
    else { showToast('error', 'Error', data.error || 'Failed to save settings'); }
  } catch(e) { showToast('error', 'Error', 'Failed to save settings'); }
}

function resetSettings() {
  if (!confirm('Reset all settings to defaults?')) return;
  document.getElementById('serverPort').value = 5000;
  document.getElementById('logLevel').value = 'INFO';
  document.getElementById('copyInterval').value = 100;
  document.getElementById('retryAttempts').value = 3;
  document.getElementById('defSlippage').value = 10;
  document.getElementById('defDelay').value = 0;
  document.getElementById('autoStart').classList.remove('is-on');
  document.getElementById('startMinimized').classList.remove('is-on');
  document.getElementById('copySL').classList.add('is-on');
  document.getElementById('copyTP').classList.add('is-on');
  document.getElementById('copyPending').classList.remove('is-on');
  showToast('info', 'Reset', 'Settings reset to defaults (click Save to apply)');
}

loadSettings();
</script>
{% endblock %}
