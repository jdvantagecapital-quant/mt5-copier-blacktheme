{% extends "base.html" %}
{% block title %}Dashboard - MT5 Trade Copier{% endblock %}
{% block page_title %}<i class="fas fa-th-large"></i> Dashboard{% endblock %}

{% block extra_css %}
<style>
    @keyframes glow-border { 0%, 100% { box-shadow: 0 0 5px rgba(255,255,255,0.03); } 50% { box-shadow: 0 0 15px rgba(255,255,255,0.08); } }
    @keyframes glow-gold { 0%, 100% { box-shadow: 0 0 8px rgba(204,136,0,0.2); } 50% { box-shadow: 0 0 20px rgba(204,136,0,0.35); } }
    @keyframes glow-blue { 0%, 100% { box-shadow: 0 0 8px rgba(0,136,204,0.2); } 50% { box-shadow: 0 0 20px rgba(0,136,204,0.35); } }
    @keyframes pulse-dot { 0%, 100% { box-shadow: 0 0 4px currentColor; } 50% { box-shadow: 0 0 12px currentColor; } }

    .overview-section { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 16px; }
    @media (max-width: 900px) { .overview-section { grid-template-columns: repeat(2, 1fr); } }
    .overview-card { background: linear-gradient(145deg, #0a0a0a, #111); border: 1px solid #1a1a1a; border-radius: 12px; padding: 18px; position: relative; animation: glow-border 4s ease-in-out infinite; }
    .overview-card::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; border-radius: 4px 0 0 4px; }
    .overview-card.pairs::before { background: linear-gradient(180deg, #667eea, #764ba2); }
    .overview-card.children::before { background: linear-gradient(180deg, #0088cc, #00aaff); }
    .overview-card.copied::before { background: linear-gradient(180deg, #00c864, #00a854); }
    .overview-card.profit::before { background: linear-gradient(180deg, #cc8800, #ffaa00); }
    .overview-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
    .overview-icon { width: 42px; height: 42px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 16px; border: 1px solid; }
    .overview-card.pairs .overview-icon { background: rgba(102,126,234,0.1); color: #667eea; border-color: rgba(102,126,234,0.2); }
    .overview-card.children .overview-icon { background: rgba(0,136,204,0.1); color: #0088cc; border-color: rgba(0,136,204,0.2); }
    .overview-card.copied .overview-icon { background: rgba(0,200,100,0.1); color: #00c864; border-color: rgba(0,200,100,0.2); }
    .overview-card.profit .overview-icon { background: rgba(204,136,0,0.1); color: #cc8800; border-color: rgba(204,136,0,0.2); }
    .overview-badge { font-size: 8px; font-weight: 600; text-transform: uppercase; padding: 4px 8px; border-radius: 10px; border: 1px solid; }
    .overview-badge.active { background: rgba(0,200,100,0.1); color: #00c864; border-color: rgba(0,200,100,0.2); }
    .overview-badge.inactive { background: rgba(255,68,102,0.1); color: #ff4466; border-color: rgba(255,68,102,0.2); }
    .overview-badge.neutral { background: rgba(102,126,234,0.1); color: #667eea; border-color: rgba(102,126,234,0.2); }
    .overview-value { font-size: 28px; font-weight: 700; font-family: 'JetBrains Mono', monospace; color: #ccc; margin-bottom: 4px; }
    .overview-value.green { color: #00c864; }
    .overview-value.red { color: #ff4466; }
    .overview-label { font-size: 11px; color: #555; text-transform: uppercase; letter-spacing: 1px; }

    /* P/L Comparison Section */
    .pnl-section { background: linear-gradient(145deg, #0a0a0a, #111); border: 1px solid #1a1a1a; border-radius: 12px; padding: 16px; margin-bottom: 16px; }
    .pnl-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px solid #1a1a1a; }
    .pnl-title { font-size: 12px; font-weight: 600; color: #888; display: flex; align-items: center; gap: 8px; }
    .pnl-title i { color: #cc8800; }
    .pnl-filter { display: flex; gap: 6px; align-items: center; }
    .pnl-filter-btn { padding: 5px 10px; font-size: 9px; font-weight: 600; background: rgba(204,136,0,0.1); color: #cc8800; border: 1px solid rgba(204,136,0,0.2); border-radius: 4px; cursor: pointer; }
    .pnl-filter-btn:hover { background: rgba(204,136,0,0.2); }
    .pnl-filter-btn.active { background: rgba(204,136,0,0.3); border-color: rgba(204,136,0,0.5); }
    .pnl-date-input { padding: 4px 8px; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary); font-size: 10px; width: 100px; -webkit-appearance: none; position: relative; }
    .pnl-date-input::-webkit-calendar-picker-indicator { filter: invert(0.8); cursor: pointer; opacity: 0.8; padding: 2px; }
    .pnl-date-input::-webkit-calendar-picker-indicator:hover { opacity: 1; }
    html[data-theme="light"] .pnl-date-input { background: #fff; border-color: #d0d2d7; color: #333; }
    html[data-theme="light"] .pnl-date-input::-webkit-calendar-picker-indicator { filter: invert(0.2); opacity: 1; }
    .pnl-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; }
    .pnl-card { background: #080808; border: 1px solid #1a1a1a; border-radius: 8px; padding: 14px; }
    .pnl-card.master { border-left: 3px solid #cc8800; }
    .pnl-card.child { border-left: 3px solid #0088cc; }
    .pnl-card.diff { border-left: 3px solid #ff4466; }
    .pnl-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .pnl-account { font-size: 10px; color: #666; font-family: 'JetBrains Mono', monospace; }
    .pnl-badge { font-size: 8px; padding: 2px 6px; border-radius: 3px; font-weight: 600; }
    .pnl-badge.master { background: rgba(204,136,0,0.15); color: #cc8800; }
    .pnl-badge.child { background: rgba(0,136,204,0.15); color: #0088cc; }
    .pnl-badge.diff { background: rgba(255,68,102,0.15); color: #ff4466; }
    .pnl-value { font-size: 20px; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
    .pnl-value.pos { color: #00c864; }
    .pnl-value.neg { color: #ff4466; }
    .pnl-label { font-size: 9px; color: #444; margin-top: 4px; }
    .pnl-diff-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-top: 1px solid #151515; margin-top: 6px; }
    .pnl-diff-label { font-size: 9px; color: #555; }
    .pnl-diff-val { font-size: 12px; font-weight: 600; font-family: 'JetBrains Mono', monospace; }

    .control-bar { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: linear-gradient(145deg, #0a0a0a, #0d0d0d); border: 1px solid #1a1a1a; border-radius: 8px; margin-bottom: 12px; }
    .control-left { display: flex; align-items: center; gap: 16px; }
    .status-indicator { display: flex; align-items: center; gap: 8px; padding: 6px 14px; background: rgba(0,200,100,0.08); border: 1px solid rgba(0,200,100,0.2); border-radius: 20px; }
    .status-indicator.stopped { background: rgba(255,68,102,0.08); border-color: rgba(255,68,102,0.2); }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #00c864; animation: pulse-dot 2s ease-in-out infinite; }
    .status-dot.stopped { background: #ff4466; }
    .status-text { font-size: 10px; font-weight: 600; letter-spacing: 1px; color: #00c864; }
    .status-text.stopped { color: #ff4466; }
    .ctrl-buttons { display: flex; gap: 8px; }
    .ctrl-btn { padding: 8px 18px; border-radius: 6px; font-size: 11px; font-weight: 600; border: 1px solid; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px; }
    .ctrl-btn.start { background: rgba(0,200,100,0.1); color: #00c864; border-color: rgba(0,200,100,0.3); }
    .ctrl-btn.start:hover:not(:disabled) { background: rgba(0,200,100,0.2); }
    .ctrl-btn.stop { background: rgba(255,68,102,0.1); color: #ff4466; border-color: rgba(255,68,102,0.3); }
    .ctrl-btn.stop:hover:not(:disabled) { background: rgba(255,68,102,0.2); }
    .ctrl-btn:disabled { opacity: 0.4; cursor: not-allowed; }

    .pair-selector { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; padding: 10px 14px; background: #0a0a0a; border: 1px solid #1a1a1a; border-radius: 6px; }
    .pair-selector label { font-size: 10px; color: #444; font-weight: 500; display: flex; align-items: center; gap: 6px; }
    .pair-select { flex: 1; max-width: 280px; padding: 8px 12px; background: #111; border: 1px solid #222; border-radius: 4px; color: #ccc; font-size: 11px; }

    .main-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 12px; margin-bottom: 16px; }

    .acc-card { background: #0a0a0a; border: 1px solid #1a1a1a; border-radius: 8px; overflow: hidden; animation: glow-border 5s ease-in-out infinite; display: flex; flex-direction: column; }
    .acc-card.master { border-left: 3px solid #cc8800; animation: glow-gold 4s ease-in-out infinite; }
    .acc-card.child { border-left: 3px solid #0088cc; animation: glow-blue 4s ease-in-out infinite; }
    .acc-header { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #151515; }
    .acc-info { display: flex; align-items: center; gap: 8px; }
    .acc-badge { font-size: 8px; font-weight: 600; padding: 3px 8px; border-radius: 3px; text-transform: uppercase; }
    .acc-badge.master { background: rgba(204,136,0,0.15); color: #cc8800; }
    .acc-badge.child { background: rgba(0,136,204,0.15); color: #0088cc; }
    .acc-num { font-family: 'JetBrains Mono', monospace; font-size: 12px; color: #888; }
    .acc-status { font-size: 9px; display: flex; align-items: center; gap: 4px; }
    .acc-status.on { color: #00c864; }
    .acc-status.off { color: #ff4466; }
    .acc-status i { font-size: 6px; }
    .bal-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 12px; background: #080808; }
    .bal-label { font-size: 9px; color: #444; text-transform: uppercase; margin-bottom: 2px; }
    .bal-value { font-size: 15px; font-weight: 600; font-family: 'JetBrains Mono', monospace; color: #ccc; }

    .acc-tabs { display: flex; border-bottom: 1px solid #151515; background: #080808; }
    .tab-btn { flex: 1; padding: 8px; font-size: 9px; color: #444; background: transparent; border: none; cursor: pointer; border-bottom: 2px solid transparent; }
    .tab-btn:hover { color: #666; }
    .tab-btn.active { color: #888; border-bottom-color: #444; }
    .tab-panel { display: none; }
    .tab-panel.show { display: block; }

    .card-filter { display: flex; align-items: center; gap: 6px; padding: 8px 12px; background: #050505; border-bottom: 1px solid #151515; flex-wrap: wrap; }
    .card-filter-label { font-size: 8px; color: #444; display: flex; align-items: center; gap: 4px; }
    .card-filter-btn { padding: 4px 8px; font-size: 8px; font-weight: 600; background: rgba(0,136,204,0.1); color: #0088cc; border: 1px solid rgba(0,136,204,0.2); border-radius: 3px; cursor: pointer; }
    .card-filter-btn:hover { background: rgba(0,136,204,0.2); }
    .card-filter-btn.active { background: rgba(0,136,204,0.3); border-color: rgba(0,136,204,0.5); }
    .card-date-input { padding: 3px 6px; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 3px; color: var(--text-primary); font-size: 9px; font-family: 'JetBrains Mono', monospace; width: 90px; -webkit-appearance: none; position: relative; }
    .card-date-input::-webkit-calendar-picker-indicator { filter: invert(0.8); cursor: pointer; opacity: 0.8; padding: 2px; }
    .card-date-input::-webkit-calendar-picker-indicator:hover { opacity: 1; }
    html[data-theme="light"] .card-date-input { background: #fff; border-color: #d0d2d7; color: #333; }
    html[data-theme="light"] .card-date-input::-webkit-calendar-picker-indicator { filter: invert(0.2); opacity: 1; }

    .trades-tbl { padding: 8px 12px 12px; overflow-y: auto; max-height: 180px; overscroll-behavior: contain; }
    .tbl-head { display: grid; grid-template-columns: 1.5fr 0.8fr 0.8fr 1fr 1fr; gap: 6px; padding: 6px 0; border-bottom: 1px solid #151515; font-size: 8px; color: #333; text-transform: uppercase; }
    .tbl-row { display: grid; grid-template-columns: 1.5fr 0.8fr 0.8fr 1fr 1fr; gap: 6px; padding: 6px 0; border-bottom: 1px solid #0d0d0d; align-items: center; }
    .t-sym { font-weight: 600; color: #888; font-size: 10px; }
    .t-type { font-size: 8px; font-weight: 600; text-transform: uppercase; }
    .t-type.buy { color: #00c864; }
    .t-type.sell { color: #ff4466; }
    .t-lots, .t-price { font-family: 'JetBrains Mono', monospace; color: #666; font-size: 9px; }
    .t-pnl { font-family: 'JetBrains Mono', monospace; font-weight: 600; text-align: right; }
    .t-pnl.pos { color: #00c864; }
    .t-pnl.neg { color: #ff4466; }

    .activity-panel { padding: 8px 12px 12px; max-height: 180px; overflow-y: auto; flex: 1; }
    .activity-item { display: flex; align-items: flex-start; gap: 6px; padding: 4px 0; border-bottom: 1px solid #111; font-size: 9px; }
    .activity-time { font-family: 'JetBrains Mono', monospace; color: #444; font-size: 8px; min-width: 45px; }
    .activity-icon { width: 16px; height: 16px; border-radius: 3px; display: flex; align-items: center; justify-content: center; font-size: 7px; border: 1px solid; flex-shrink: 0; }
    .activity-icon.TRADE { background: rgba(0,200,100,0.1); color: #00c864; border-color: rgba(0,200,100,0.2); }
    .activity-icon.CLOSE { background: rgba(255,68,102,0.1); color: #ff4466; border-color: rgba(255,68,102,0.2); }
    .activity-icon.INFO { background: rgba(0,136,204,0.1); color: #0088cc; border-color: rgba(0,136,204,0.2); }
    .activity-icon.SIGNAL { background: rgba(204,136,0,0.1); color: #cc8800; border-color: rgba(204,136,0,0.2); }
    .activity-icon.ERROR { background: rgba(255,68,102,0.1); color: #ff4466; border-color: rgba(255,68,102,0.2); }
    .activity-msg { color: #666; flex: 1; line-height: 1.3; word-break: break-word; }

    .total-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: #080808; border-top: 1px solid #1a1a1a; margin-top: auto; }
    .total-lbl { font-size: 9px; color: #444; font-weight: 500; text-transform: uppercase; }
    .total-val { font-size: 14px; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
    .total-val.pos { color: #00c864; }
    .total-val.neg { color: #ff4466; }

    .empty-msg { padding: 20px; text-align: center; color: #333; font-size: 10px; }
    .no-pairs { padding: 40px; text-align: center; background: #0a0a0a; border: 1px dashed #222; border-radius: 8px; }
    .no-pairs i { font-size: 30px; color: #222; margin-bottom: 12px; display: block; }
    .no-pairs h3 { color: #555; margin-bottom: 6px; font-size: 14px; }
    .no-pairs p { color: #333; margin-bottom: 12px; font-size: 11px; }
    .no-pairs a { color: #0088cc; font-weight: 600; text-decoration: none; }
    .error-msg { color: #ff4466; font-size: 9px; padding: 8px 12px; background: rgba(255,68,102,0.05); border-bottom: 1px solid rgba(255,68,102,0.1); }

    /* Light theme fixes */
    html[data-theme="light"] .overview-value { color: #111; }
    html[data-theme="light"] .overview-value.green { color: #00a854; }
    html[data-theme="light"] .overview-value.red { color: #ff4466; }
</style>
{% endblock %}

{% block content %}
<div class="overview-section" style="grid-template-columns: repeat(3, 1fr);">
    <div class="overview-card pairs">
        <div class="overview-top"><div class="overview-icon"><i class="fas fa-crown"></i></div><span class="overview-badge neutral" id="pairsStatus">Configured</span></div>
        <div class="overview-value" id="totalPairs">0</div>
        <div class="overview-label">Trading Pairs</div>
    </div>
    <div class="overview-card children">
        <div class="overview-top"><div class="overview-icon"><i class="fas fa-users"></i></div><span class="overview-badge neutral" id="childrenStatus">Connected</span></div>
        <div class="overview-value" id="totalChildren">0</div>
        <div class="overview-label">Child Accounts</div>
    </div>
    <div class="overview-card copied">
        <div class="overview-top"><div class="overview-icon"><i class="fas fa-copy"></i></div><span class="overview-badge active" id="copiedStatus">Today</span></div>
        <div class="overview-value" id="totalCopied">0</div>
        <div class="overview-label">Trades Copied</div>
    </div>
</div>

<!-- P/L Comparison Section -->
<div class="pnl-section" id="pnlSection">
    <div class="pnl-header">
        <div class="pnl-title"><i class="fas fa-chart-bar"></i> P/L Comparison</div>
        <div class="pnl-filter">
            <button class="pnl-filter-btn active" onclick="setPnlFilter('today')">Today</button>
            <button class="pnl-filter-btn" onclick="setPnlFilter('7days')">7D</button>
            <button class="pnl-filter-btn" onclick="setPnlFilter('30days')">30D</button>
            <input type="date" class="pnl-date-input" id="pnl_from">
            <input type="date" class="pnl-date-input" id="pnl_to">
            <button class="pnl-filter-btn" onclick="applyPnlCustomDate()"><i class="fas fa-check"></i></button>
        </div>
    </div>
    <div class="pnl-grid" id="pnlGrid"></div>
</div>

<div class="control-bar">
    <div class="control-left">
        <div class="status-indicator stopped" id="statusIndicator">
            <div class="status-dot stopped" id="statusDot"></div>
            <span class="status-text stopped" id="statusText">STOPPED</span>
        </div>
    </div>
    <div class="ctrl-buttons">
        <button class="ctrl-btn start" id="btnStart" onclick="startCopier()"><i class="fas fa-play"></i> Start</button>
        <button class="ctrl-btn stop" id="btnStop" onclick="stopCopier()" disabled><i class="fas fa-stop"></i> Stop</button>
    </div>
</div>

<div class="pair-selector">
    <label><i class="fas fa-exchange-alt"></i> Active Pair</label>
    <select class="pair-select" id="pairSelect" onchange="selectPair()"><option value="">Select a pair...</option></select>
</div>

<div class="main-grid" id="accountsContainer"></div>
{% endblock %}

{% block extra_js %}
<script>
let allPairs = [], selectedPairId = null, selectedPair = null, processStatus = {};
let globalStats = { total: 0, success: 0, failed: 0 }, isRunning = false;
let tradeData = { master: { balance: 0, equity: 0, positions: [], closed_trades: [] }, children: {}, child_data: {}, activities: {}, closed_master: [], closed_children: {} };
let activeTab = {};
let cardFilters = {};  // Independent filter for each card
let pnlFilter = { type: 'today' };  // Global P/L filter
let pnlData = { master: { positions: [] }, children: {}, closed_master: [], closed_children: {} };

function formatDate(d) { return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0'); }

function getCardDateParams(cardId) {
    const filter = cardFilters[cardId] || { type: '30days' };
    const today = new Date(); today.setHours(0,0,0,0);
    let from, to;
    switch(filter.type) {
        case 'today': from = to = formatDate(today); break;
        case 'yesterday': const y = new Date(today); y.setDate(y.getDate()-1); from = to = formatDate(y); break;
        case '7days': const s7 = new Date(today); s7.setDate(s7.getDate()-7); from = formatDate(s7); to = formatDate(today); break;
        case '30days': const s30 = new Date(today); s30.setDate(s30.getDate()-30); from = formatDate(s30); to = formatDate(today); break;
        case 'custom': from = filter.from || formatDate(today); to = filter.to || formatDate(today); break;
        default: const def = new Date(today); def.setDate(def.getDate()-30); from = formatDate(def); to = formatDate(today);
    }
    return { date_from: from, date_to: to };
}

function getPnlDateParams() {
    const today = new Date(); today.setHours(0,0,0,0);
    let from, to;
    switch(pnlFilter.type) {
        case 'today': from = to = formatDate(today); break;
        case '7days': const s7 = new Date(today); s7.setDate(s7.getDate()-7); from = formatDate(s7); to = formatDate(today); break;
        case '30days': const s30 = new Date(today); s30.setDate(s30.getDate()-30); from = formatDate(s30); to = formatDate(today); break;
        case 'custom': from = pnlFilter.from; to = pnlFilter.to; break;
        default: from = to = formatDate(today);
    }
    return { date_from: from, date_to: to };
}

async function loadPairs() {
    console.log('loadPairs called');
    try { 
        const res = await fetch('/api/pairs'); 
        console.log('API response:', res.status);
        allPairs = await res.json(); 
        console.log('Pairs loaded:', allPairs.length, allPairs);
    } catch(e) { 
        console.error('loadPairs error:', e);
        allPairs = []; 
    }
    const select = document.getElementById('pairSelect');
    updateOverviewStats();
    if (!allPairs.length) {
        console.log('No pairs found, showing empty state');
        select.innerHTML = '<option value="">No pairs configured</option>';
        document.getElementById('accountsContainer').innerHTML = '<div class="no-pairs" style="grid-column:1/-1"><i class="fas fa-plug"></i><h3>No Copy Pairs</h3><p>Configure pairs to start</p><a href="/accounts"><i class="fas fa-plus"></i> Add Pair</a></div>';
        return;
    }
    console.log('Populating dropdown with', allPairs.length, 'pairs');
    select.innerHTML = allPairs.map(p => '<option value="'+p.id+'">'+(p.name||'Pair')+' ('+p.master_account+')</option>').join('');
    const saved = localStorage.getItem('selectedPairId');
    if (saved && allPairs.find(p => p.id === saved)) select.value = saved;
    selectPair();
}

function updateOverviewStats() {
    document.getElementById('totalPairs').textContent = allPairs.length;
    let tc = 0; allPairs.forEach(p => tc += (p.children||[]).length);
    document.getElementById('totalChildren').textContent = tc;
    document.getElementById('pairsStatus').textContent = allPairs.length > 0 ? 'Active' : 'None';
    document.getElementById('pairsStatus').className = 'overview-badge ' + (allPairs.length > 0 ? 'active' : 'inactive');
    document.getElementById('childrenStatus').textContent = tc > 0 ? 'Ready' : 'None';
    document.getElementById('childrenStatus').className = 'overview-badge ' + (tc > 0 ? 'active' : 'inactive');
}

function selectPair() {
    const select = document.getElementById('pairSelect');
    selectedPairId = select.value;
    localStorage.setItem('selectedPairId', selectedPairId);
    selectedPair = allPairs.find(p => p.id === selectedPairId);
    activeTab = {}; 
    // Reset card filters - each card gets its own filter
    cardFilters = {};
    if (selectedPair) {
        cardFilters['master'] = { type: '30days' };
        (selectedPair.children||[]).forEach((c,i) => cardFilters['child_'+i] = { type: '30days' });
    }
    loadData();
}

async function loadDataForCard(cardId, isChild, childId) {
    // Get card-specific date params
    const params = getCardDateParams(cardId);
    const url = '/api/pairs/' + selectedPairId + '/mt5-data?date_from=' + params.date_from + '&date_to=' + params.date_to + '&card=' + cardId + (isChild ? '&child_id=' + childId : '');
    
    try {
        const res = await fetch(url);
        return await res.json();
    } catch(e) {
        return null;
    }
}

async function loadData() {
    if (!selectedPairId || !selectedPair) return;
    try { const res = await fetch('/api/process-status'); processStatus = (await res.json()).status || {}; } catch(e) { processStatus = {}; }
    const pairStatus = processStatus[selectedPairId];
    isRunning = pairStatus && pairStatus.master_running;
    updateStatusUI();

    // Load master data with master's own filter
    const masterParams = getCardDateParams('master');
    let masterUrl = '/api/pairs/' + selectedPairId + '/mt5-data?date_from=' + masterParams.date_from + '&date_to=' + masterParams.date_to + '&days=30';
    
    try {
        const res = await fetch(masterUrl);
        const data = await res.json();
        if (data.success) {
            tradeData = {
                master: data.master || { balance: 0, equity: 0, positions: [], closed_trades: [] },
                children: {},
                child_data: {},
                activities: data.activities || {},
                closed_master: data.closed_master || [],
                closed_children: data.closed_children || {}
            };
            tradeData.balance = data.master?.balance || data.balance || 0;
            tradeData.equity = data.master?.equity || data.equity || 0;
            
            // Map children data
            (selectedPair.children||[]).forEach((child, i) => {
                const cid = child.id;
                const childData = data.children?.[cid] || {};
                tradeData.children[cid] = childData.positions || data.children?.[cid] || [];
                tradeData.child_data[cid] = { 
                    balance: childData.balance || data.child_data?.[cid]?.balance || 0, 
                    equity: childData.equity || data.child_data?.[cid]?.equity || 0 
                };
            });
        }
    } catch(e) {
        console.error('Load data error:', e);
        tradeData = { master: { balance: 0, equity: 0, positions: [] }, children: {}, child_data: {}, activities: {}, closed_master: [], closed_children: {}, balance: 0, equity: 0 };
    }
    
    // Load each child with its own filter
    for (let i = 0; i < (selectedPair.children||[]).length; i++) {
        const child = selectedPair.children[i];
        const cardId = 'child_' + i;
        const childParams = getCardDateParams(cardId);
        
        try {
            const childUrl = '/api/pairs/' + selectedPairId + '/mt5-data?date_from=' + childParams.date_from + '&date_to=' + childParams.date_to + '&child_id=' + child.id;
            const res = await fetch(childUrl);
            const childData = await res.json();
            if (childData.success && childData.children?.[child.id]) {
                tradeData.closed_children[child.id] = childData.closed_children?.[child.id] || [];
            }
        } catch(e) {}
    }
    
    try { const res3 = await fetch('/api/status'); globalStats = (await res3.json()).stats || { total: 0, success: 0, failed: 0 }; } catch(e) { globalStats = { total: 0, success: 0, failed: 0 }; }
    
    renderAccounts();
    loadPnlData();  // This will call renderPnlSection after loading P/L data
    updateStats();
}

function updateStatusUI() {
    const indicator = document.getElementById('statusIndicator');
    const dot = document.getElementById('statusDot');
    const txt = document.getElementById('statusText');
    if (isRunning) {
        indicator.className = 'status-indicator'; dot.className = 'status-dot'; txt.className = 'status-text'; txt.textContent = 'RUNNING';
        document.getElementById('btnStart').disabled = true; document.getElementById('btnStop').disabled = false;
    } else {
        indicator.className = 'status-indicator stopped'; dot.className = 'status-dot stopped'; txt.className = 'status-text stopped'; txt.textContent = 'STOPPED';
        document.getElementById('btnStart').disabled = false; document.getElementById('btnStop').disabled = true;
    }
}

function setCardFilter(cardId, type) {
    cardFilters[cardId] = { type: type };
    loadData();
}

function applyCardCustomDate(cardId) {
    const from = document.getElementById('date_from_'+cardId)?.value;
    const to = document.getElementById('date_to_'+cardId)?.value;
    if (from && to) {
        cardFilters[cardId] = { type: 'custom', from: from, to: to };
        loadData();
    }
}

function setPnlFilter(type) {
    pnlFilter = { type: type };
    document.querySelectorAll('.pnl-filter-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
    loadPnlData();  // Changed from loadData()
}

function applyPnlCustomDate() {
    const from = document.getElementById('pnl_from')?.value;
    const to = document.getElementById('pnl_to')?.value;
    if (from && to) {
        pnlFilter = { type: 'custom', from: from, to: to };
        document.querySelectorAll('.pnl-filter-btn').forEach(b => b.classList.remove('active'));
        loadPnlData();  // Changed from loadData()
    }
}

async function loadPnlData() {
    if (!selectedPairId || !selectedPair) return;
    
    const params = getPnlDateParams();
    const url = '/api/pairs/' + selectedPairId + '/mt5-data?date_from=' + params.date_from + '&date_to=' + params.date_to;
    
    try {
        const res = await fetch(url);
        const data = await res.json();
        if (data.success) {
            pnlData = {
                master: data.master || { positions: [] },
                children: {},
                closed_master: data.closed_master || [],
                closed_children: data.closed_children || {}
            };
            
            (selectedPair.children||[]).forEach((child) => {
                const cid = child.id;
                pnlData.children[cid] = data.children?.[cid]?.positions || data.children?.[cid] || [];
            });
        }
    } catch(e) {
        console.error('Load P/L data error:', e);
        pnlData = { master: { positions: [] }, children: {}, closed_master: [], closed_children: {} };
    }
    
    renderPnlSection();
}

function renderPnlSection() {
    if (!selectedPair) { document.getElementById('pnlGrid').innerHTML = ''; return; }
    
    const masterPositions = pnlData.master?.positions || [];
    const masterPnl = masterPositions.reduce((s,t) => s + (parseFloat(t.profit)||0), 0);
    const closedMasterPnl = (pnlData.closed_master || []).reduce((s,t) => s + (parseFloat(t.profit)||0), 0);
    const totalMasterPnl = masterPnl + closedMasterPnl;
    
    let html = '';
    
    // Master P/L Card
    html += '<div class="pnl-card master">';
    html += '<div class="pnl-card-header"><span class="pnl-account">' + selectedPair.master_account + '</span><span class="pnl-badge master">MASTER</span></div>';
    html += '<div class="pnl-value ' + (totalMasterPnl >= 0 ? 'pos' : 'neg') + '">' + (totalMasterPnl >= 0 ? '+' : '') + totalMasterPnl.toFixed(2) + '</div>';
    html += '<div class="pnl-label">Total P/L (Floating + Closed)</div>';
    html += '<div class="pnl-diff-row"><span class="pnl-diff-label">Floating</span><span class="pnl-diff-val ' + (masterPnl >= 0 ? 'pos' : 'neg') + '">' + (masterPnl >= 0 ? '+' : '') + masterPnl.toFixed(2) + '</span></div>';
    html += '<div class="pnl-diff-row"><span class="pnl-diff-label">Closed</span><span class="pnl-diff-val ' + (closedMasterPnl >= 0 ? 'pos' : 'neg') + '">' + (closedMasterPnl >= 0 ? '+' : '') + closedMasterPnl.toFixed(2) + '</span></div>';
    html += '</div>';
    
    // Children P/L Cards with difference
    (selectedPair.children||[]).forEach((child, i) => {
        const cid = child.id;
        const childPositions = Array.isArray(pnlData.children?.[cid]) ? pnlData.children[cid] : [];
        const childPnl = childPositions.reduce((s,t) => s + (parseFloat(t.profit)||0), 0);
        const closedChildPnl = (pnlData.closed_children?.[cid] || []).reduce((s,t) => s + (parseFloat(t.profit)||0), 0);
        const totalChildPnl = childPnl + closedChildPnl;
        const diff = totalChildPnl - totalMasterPnl;
        
        html += '<div class="pnl-card child">';
        html += '<div class="pnl-card-header"><span class="pnl-account">' + child.account + '</span><span class="pnl-badge child">CHILD ' + (i+1) + '</span></div>';
        html += '<div class="pnl-value ' + (totalChildPnl >= 0 ? 'pos' : 'neg') + '">' + (totalChildPnl >= 0 ? '+' : '') + totalChildPnl.toFixed(2) + '</div>';
        html += '<div class="pnl-label">Total P/L</div>';
        html += '<div class="pnl-diff-row"><span class="pnl-diff-label">Floating</span><span class="pnl-diff-val ' + (childPnl >= 0 ? 'pos' : 'neg') + '">' + (childPnl >= 0 ? '+' : '') + childPnl.toFixed(2) + '</span></div>';
        html += '<div class="pnl-diff-row"><span class="pnl-diff-label">Closed</span><span class="pnl-diff-val ' + (closedChildPnl >= 0 ? 'pos' : 'neg') + '">' + (closedChildPnl >= 0 ? '+' : '') + closedChildPnl.toFixed(2) + '</span></div>';
        html += '<div class="pnl-diff-row" style="background: rgba(255,68,102,0.05); margin: 6px -14px -14px; padding: 8px 14px; border-radius: 0 0 5px 5px;"><span class="pnl-diff-label" style="color: #ff4466;">vs Master</span><span class="pnl-diff-val ' + (diff >= 0 ? 'pos' : 'neg') + '">' + (diff >= 0 ? '+' : '') + diff.toFixed(2) + '</span></div>';
        html += '</div>';
    });
    
    document.getElementById('pnlGrid').innerHTML = html;
}

function parseActivity(activity) {
    if (typeof activity === 'string') {
        const parts = activity.split('|').map(p => p.trim());
        if (parts.length >= 3) return { time: parts[0].split(' ')[1] || parts[0], type: parts[1] || 'INFO', message: parts.slice(2).join(' | ') };
        return { time: '', type: 'INFO', message: activity };
    }
    return { time: activity.time || '', type: activity.type || 'INFO', message: activity.message || activity.msg || '' };
}

function renderAccounts() {
    const container = document.getElementById('accountsContainer');
    if (!selectedPair) { container.innerHTML = ''; return; }
    
    const children = selectedPair.children || [];
    const masterPositions = tradeData.master?.positions || (Array.isArray(tradeData.master) ? tradeData.master : []);
    const masterPnl = masterPositions.reduce((s,t) => s + (parseFloat(t.profit)||0), 0);
    const masterActivities = Array.isArray(tradeData.activities?.master) ? tradeData.activities.master : [];
    const closedMaster = tradeData.closed_master || tradeData.master?.closed_trades || [];
    const masterError = tradeData.master?.error;
    
    let html = buildCard('master', 'master', selectedPair.master_account, 
        tradeData.balance || tradeData.master?.balance || 0, 
        tradeData.equity || tradeData.master?.equity || 0, 
        masterPositions, masterPnl, isRunning, masterActivities, closedMaster, masterError);
    
    if (children.length > 0) {
        children.forEach((child, i) => {
            const cid = child.id;
            const cardId = 'child_' + i;
            const childPositions = Array.isArray(tradeData.children?.[cid]) ? tradeData.children[cid] : [];
            const childInfo = tradeData.child_data?.[cid] || {};
            const childPnl = childPositions.reduce((s,t) => s + (parseFloat(t.profit)||0), 0);
            const childActivities = Array.isArray(tradeData.activities?.[cid]) ? tradeData.activities[cid] : [];
            const closedChild = Array.isArray(tradeData.closed_children?.[cid]) ? tradeData.closed_children[cid] : [];
            const childConnected = isRunning && child.enabled;
            const childError = childInfo.error;
            html += buildCard(cardId, 'child', child.account, childInfo.balance||0, childInfo.equity||0, childPositions, childPnl, childConnected, childActivities, closedChild, childError);
        });
    } else {
        html += '<div class="acc-card child"><div class="empty-msg">No child accounts configured</div></div>';
    }
    // Save scroll positions before re-render
    const scrollPositions = {};
    container.querySelectorAll('.trades-tbl, .activity-panel').forEach(el => {
        const id = el.closest('.acc-card')?.id + '_' + (el.classList.contains('trades-tbl') ? 'trades' : 'activity');
        if (el.scrollTop > 0) scrollPositions[id] = el.scrollTop;
    });
    container.innerHTML = html;
    for (const cardId in activeTab) switchTab(cardId, activeTab[cardId]);
    // Restore scroll positions
    container.querySelectorAll('.trades-tbl, .activity-panel').forEach(el => {
        const id = el.closest('.acc-card')?.id + '_' + (el.classList.contains('trades-tbl') ? 'trades' : 'activity');
        if (scrollPositions[id]) el.scrollTop = scrollPositions[id];
    });
}

function buildCard(cardId, type, account, balance, equity, trades, pnl, connected, activities, closedTrades, error) {
    const pnlClass = pnl >= 0 ? 'pos' : 'neg';
    const currentTab = activeTab[cardId] || 'live';
    const currentFilter = cardFilters[cardId]?.type || '30days';
    
    let html = '<div class="acc-card '+type+'" id="card_'+cardId+'">';
    html += '<div class="acc-header"><div class="acc-info"><span class="acc-badge '+type+'">'+type.toUpperCase()+'</span><span class="acc-num">'+account+'</span></div>';
    html += '<div class="acc-status '+(connected?'on':'off')+'"><i class="fas fa-circle"></i> '+(connected?'On':'Off')+'</div></div>';
    
    if (error) html += '<div class="error-msg"><i class="fas fa-exclamation-triangle"></i> '+error+'</div>';
    
    html += '<div class="bal-row"><div><div class="bal-label">Balance</div><div class="bal-value">$'+formatMoney(balance)+'</div></div>';
    html += '<div><div class="bal-label">Equity</div><div class="bal-value">$'+formatMoney(equity)+'</div></div></div>';
    
    html += '<div class="card-filter">';
    html += '<span class="card-filter-label"><i class="fas fa-calendar-alt"></i></span>';
    ['today','yesterday','7days','30days'].forEach(f => {
        const label = f === 'today' ? 'Today' : f === 'yesterday' ? 'Yest' : f === '7days' ? '7D' : '30D';
        html += '<button class="card-filter-btn '+(currentFilter===f?'active':'')+'" onclick="setCardFilter(\''+cardId+'\',\''+f+'\')">'+label+'</button>';
    });
    html += '<input type="date" class="card-date-input" id="date_from_'+cardId+'" style="margin-left:4px">';
    html += '<input type="date" class="card-date-input" id="date_to_'+cardId+'">';
    html += '<button class="card-filter-btn" onclick="applyCardCustomDate(\''+cardId+'\')"><i class="fas fa-check"></i></button>';
    html += '</div>';
    
    html += '<div class="acc-tabs">';
    html += '<button class="tab-btn '+(currentTab==='live'?'active':'')+'" onclick="switchTab(\''+cardId+'\',\'live\')">Live ('+trades.length+')</button>';
    html += '<button class="tab-btn '+(currentTab==='closed'?'active':'')+'" onclick="switchTab(\''+cardId+'\',\'closed\')">Closed ('+(closedTrades?.length||0)+')</button>';
    html += '<button class="tab-btn '+(currentTab==='activity'?'active':'')+'" onclick="switchTab(\''+cardId+'\',\'activity\')">Activity</button></div>';
    
    // Live tab
    html += '<div class="tab-panel '+(currentTab==='live'?'show':'')+'" id="'+cardId+'_live"><div class="trades-tbl">';
    html += '<div class="tbl-head"><span>Symbol</span><span>Type</span><span>Lots</span><span>Price</span><span style="text-align:right">P/L</span></div>';
    if (trades && trades.length > 0) {
        trades.forEach(t => {
            const dir = (t.type===0||t.type==='buy'||t.type==='BUY')?'buy':'sell';
            const profit = parseFloat(t.profit)||0;
            html += '<div class="tbl-row"><span class="t-sym">'+(t.symbol||'N/A')+'</span><span class="t-type '+dir+'">'+dir.toUpperCase()+'</span>';
            html += '<span class="t-lots">'+(parseFloat(t.volume)||0).toFixed(2)+'</span><span class="t-price">'+(t.price_open||t.price||0)+'</span>';
            html += '<span class="t-pnl '+(profit>=0?'pos':'neg')+'">'+(profit>=0?'+':'')+profit.toFixed(2)+'</span></div>';
        });
    } else { html += '<div class="empty-msg">No open positions</div>'; }
    html += '</div></div>';
    
    // Closed tab
    html += '<div class="tab-panel '+(currentTab==='closed'?'show':'')+'" id="'+cardId+'_closed"><div class="trades-tbl">';
    html += '<div class="tbl-head"><span>Symbol</span><span>Type</span><span>Lots</span><span>Close</span><span style="text-align:right">P/L</span></div>';
    if (closedTrades && closedTrades.length > 0) {
        closedTrades.forEach(t => {
            const dir = (t.type===0||t.type==='buy'||t.type==='BUY')?'buy':'sell';
            const profit = parseFloat(t.profit)||0;
            html += '<div class="tbl-row"><span class="t-sym">'+(t.symbol||'N/A')+'</span><span class="t-type '+dir+'">'+dir.toUpperCase()+'</span>';
            html += '<span class="t-lots">'+(parseFloat(t.volume)||0).toFixed(2)+'</span><span class="t-price">'+(t.close_price||t.price||0)+'</span>';
            html += '<span class="t-pnl '+(profit>=0?'pos':'neg')+'">'+(profit>=0?'+':'')+profit.toFixed(2)+'</span></div>';
        });
    } else { html += '<div class="empty-msg">No closed trades for selected period</div>'; }
    html += '</div></div>';
    
    // Activity tab
    html += '<div class="tab-panel '+(currentTab==='activity'?'show':'')+'" id="'+cardId+'_activity"><div class="activity-panel">';
    if (activities && activities.length > 0) {
        activities.slice(0,25).map(parseActivity).forEach(a => {
            const icons = { TRADE:'arrow-up', CLOSE:'arrow-down', SIGNAL:'bolt', INFO:'info-circle', ERROR:'exclamation-triangle', OPEN:'arrow-up' };
            html += '<div class="activity-item"><span class="activity-time">'+a.time+'</span>';
            html += '<span class="activity-icon '+a.type+'"><i class="fas fa-'+(icons[a.type]||'info-circle')+'"></i></span>';
            html += '<span class="activity-msg">'+a.message+'</span></div>';
        });
    } else { html += '<div class="empty-msg">No recent activity</div>'; }
    html += '</div></div>';
    
    html += '<div class="total-row"><span class="total-lbl">Floating P/L</span><span class="total-val '+pnlClass+'">'+(pnl>=0?'+':'')+pnl.toFixed(2)+'</span></div></div>';
    return html;
}

function switchTab(cardId, tabName) {
    activeTab[cardId] = tabName;
    const card = document.getElementById('card_'+cardId);
    if (!card) return;
    const tabs = ['live','closed','activity'];
    card.querySelectorAll('.tab-btn').forEach((btn,i) => btn.className = 'tab-btn'+(i===tabs.indexOf(tabName)?' active':''));
    card.querySelectorAll('.tab-panel').forEach(p => p.className = 'tab-panel');
    const panel = document.getElementById(cardId+'_'+tabName);
    if (panel) panel.className = 'tab-panel show';
}

function formatMoney(val) { return (parseFloat(val)||0).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}); }

function updateStats() {
    const masterPositions = tradeData.master?.positions || (Array.isArray(tradeData.master) ? tradeData.master : []);
    const totalPnl = masterPositions.reduce((s,t) => s + (parseFloat(t.profit)||0), 0);
    document.getElementById('totalCopied').textContent = globalStats.total || 0;
    const profitEl = document.getElementById('totalProfit');
    profitEl.textContent = (totalPnl>=0?'+':'')+totalPnl.toFixed(2);
    profitEl.className = 'overview-value '+(totalPnl>=0?'green':'red');
    const ps = document.getElementById('profitStatus');
    ps.textContent = totalPnl > 0 ? 'Profit' : totalPnl < 0 ? 'Loss' : 'Neutral';
    ps.className = 'overview-badge '+(totalPnl > 0 ? 'active' : totalPnl < 0 ? 'inactive' : 'neutral');
}

async function startCopier() {
    document.getElementById('btnStart').disabled = true;
    try { await fetch('/api/pairs/'+selectedPairId+'/start', {method:'POST'}); setTimeout(loadData, 300); } catch(e) { document.getElementById('btnStart').disabled = false; }
}

async function stopCopier() {
    document.getElementById('btnStop').disabled = true;
    try { await fetch('/api/pairs/'+selectedPairId+'/stop', {method:'POST'}); setTimeout(loadData, 300); } catch(e) { document.getElementById('btnStop').disabled = false; }
}

loadPairs();
setInterval(() => { if (document.activeElement && document.activeElement.type === 'date') return; loadData(); }, 800);
</script>
{% endblock %}
